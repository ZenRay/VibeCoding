<!--
=============================================================================
宪章同步影响报告
=============================================================================
版本变更: 1.0.0
理由: MINOR 版本升级 - 新增 Git 提交规范原则

修改的原则:
- 新增: XI. Git 提交规范 (非妥协)

原则总数: 10 条 → 11 条

新增内容详情:
1. **原则 XI - Git 提交规范**:
   - 强制代码格式化 (git add 前执行 ruff format)
   - 强制代码质量检查 (git commit 前执行 ruff/mypy/pytest)
   - 强制 Conventional Commits 提交消息格式
   - 强制明确 push 操作,禁止自动推送
   - 提供自动化检查脚本和完整工作流示例

依赖工具更新状态:
- ✅ .specify/scripts/bash/pre-commit-check.sh: 已创建

影响范围:
- 所有 Git 提交必须遵循三步检查: 格式化 → 质量检查 → 规范提交
- Speckit 实现流程需集成自动检查
- 所有开发者需安装并使用预提交检查脚本
- Git push 必须明确指定远程和分支,禁止自动推送

后续待办:

最后修订日期: 2026-01-15
=============================================================================
-->

# 项目宪章

## 核心原则

### I. 核心技术栈要求

**强制要求**:
- 必须基于 **Python 3.X** 实现
- 严禁自行实现基础调用逻辑,除非 SDK 功能缺失且有充分文档证明

**理由**: 统一技术栈确保长期维护性、安全更新及时性和团队协作效率。

---

### II. 代码质量门禁

#### 2.1 Python 代码质量门禁
**强制要求**:
- 代码必须达不低于 **99%** 的静态类型检查覆盖率 (mypy)
- 必须严格执行 **ruff** 格式化标准
- 所有 PR 必须通过质量门禁检查,无例外
- 所有公共函数、类和模块必须包含符合标准格式的 **Docstring**

**Docstring 标准格式**:
```python
def function_name(arg1: Type1, arg2: Type2) -> ReturnType:
    """
    Brief description in one line.

    Args:
    ----------
        arg1: Description of arg1
        arg2: Description of arg2

    Returns:
    ----------
        Description of return value

    Raises:
    ----------
        ExceptionType: When and why this exception is raised

    Example:
    ----------
        >>> result = function_name(value1, value2)
        >>> assert result is not None
    """
    pass
```

**Docstring 要求**:
- 必须包含简要描述(单行)
- 必须包含 `Args` 部分(如有参数)
- 必须包含 `Returns` 部分(如有返回值)
- 必须包含 `Raises` 部分(如抛出异常)
- 建议包含 `Example` 部分展示典型用法
- 使用英文编写,简洁明确
- 每个部分使用 `----------` 分隔线

**理由**: 静态类型检查在编译期捕获大量运行时错误,显著提升代码可靠性。统一格式化标准消除代码审查中的样式争议,聚焦业务逻辑审查。标准化的 Docstring 确保代码自文档化,提升可维护性和团队协作效率。

---

### III. 架构完整性 (非妥协)

**强制要求**:
- 坚持 **领域驱动的模块化设计** (DDD)
- 每个功能域必须具备清晰的边界和独立的职责
- 跨域交互必须通过明确定义的接口或事件进行

**理由**: 循环依赖会导致模块耦合、测试困难、重构风险高。领域驱动设计确保业务逻辑清晰映射到代码结构,提升可维护性和可扩展性。

---

### IV. 响应一致性

**强制要求**:
- 所有暴露给内部系统的接口必须返回 **标准化响应结构**
- 响应结构必须包含:
  - **业务状态码** (独立于 HTTP 状态码)
  - **请求 ID** (用于全链路追踪)
  - **语义化错误上下文** (包含错误类型、错误消息、可选的错误详情)
- 禁止直接抛出未处理的异常到接口层

**理由**: 统一响应格式简化客户端错误处理逻辑,请求 ID 支持分布式追踪和问题排查,语义化错误提升开发者体验。

---

---

### VIII. 测试先行 (非妥协)

**强制要求**:
- 必须先编写 **失败的单元测试**,再进行功能实现
- 严格遵循 **红-绿-重构** 循环:
  1. **红**: 编写测试,验证失败
  2. **绿**: 实现最小可行代码,使测试通过
  3. **重构**: 优化代码结构,保持测试通过
- 所有 PR 必须包含对应的测试代码
- 测试覆盖率目标: 关键业务逻辑 ≥ 90%

**理由**: 测试先行确保需求被正确理解,避免过度设计。失败测试验证测试有效性。TDD 提升代码可测试性和设计质量。

---

### IX. 文档语言规范

**强制要求**:

**代码层面 (必须英文)**:
- 变量命名、函数命名、类命名、模块命名 - 必须使用英文
- 代码注释、文档字符串 (docstring) - 必须使用英文
- 日志消息 - 必须使用英文 (便于日志分析和国际化)
- API 端点路径、参数名 - 必须使用英文

**文档层面 (使用中文)**:
- 需求文档、设计文档、API 使用文档
- README.md、CHANGELOG.md
- 代码审查评论、Issue 描述、PR 描述
- 项目计划、技术方案、架构设计文档

**理由**: 代码使用英文是国际惯例,便于代码复用、开源协作和技术交流。中文文档降低团队内部沟通成本,提升协作效率。明确分离两个层面,各取所长。

---

### X. 文件操作闭环 (非妥协)

**强制要求**:
- 所有文件创建、修改、检查操作必须形成 **闭环**
- 创建文件后,必须在 **同一文档/同一位置** 执行后续的检查和更新
- 严禁过度创建新文档,必须在原有文档上迭代改进
- 文档更新必须使用 **原地修改** (in-place update),而非创建新版本文件
- 验证和修正操作必须在原文件上完成,确保单一事实来源 (Single Source of Truth)

**具体实施**:
- ✅ **正确**: 创建 `spec.md` → 检查 `spec.md` → 更新 `spec.md` (闭环)
- ❌ **错误**: 创建 `spec.md` → 检查 `spec.md` → 创建 `spec_v2.md` (过度新建)
- ✅ **正确**: 发现问题 → 在原文件修复 → 重新验证原文件
- ❌ **错误**: 发现问题 → 创建 `fixes.md` 说明问题 → 原文件未更新

**适用场景**:
- 规范文档 (spec.md) 的创建、验证、修正
- 计划文档 (plan.md) 的创建、完善、更新
- 任务清单 (tasks.md) 的创建、检查、调整
- 代码文件的创建、测试、重构
- 配置文件的创建、验证、修改

**例外情况**:
- 版本归档 (如 `CHANGELOG.md` 记录历史版本)
- 备份文件 (明确标记为 `.backup` 或 `.old`)
- 临时工作文件 (必须在任务完成后删除)

**理由**: 文件闭环确保文档和代码的唯一性和一致性,避免信息分散和版本混乱。原地更新减少文件冗余,降低维护成本,确保团队始终使用最新、最准确的文件版本。

---

### XI. Git 提交规范 (非妥协)

**强制要求**:

#### 1. 代码格式化 (git add 前)
- **git add 前**必须运行 `ruff format .`
- 确保所有代码符合统一格式标准
- 格式化必须在暂存之前完成
- 避免提交包含格式不一致的代码

#### 2. 代码质量检查 (git commit 前)
##### 2.1 Python 代码质量检查
**三项必检**:
- `ruff check src/ tests/ --fix` - 代码风格检查并自动修复
- `mypy src/` - 类型检查,必须 0 错误
- `pytest tests/` - 测试运行,必须全部通过

**检查顺序**:
1. **Ruff 检查** → 自动修复代码风格问题
2. **Mypy 检查** → 验证类型安全,确保 99%+ 覆盖率
3. **Pytest 检查** → 确保功能正确,维持测试覆盖率 ≥ 80%

**失败处理**:
- 任何检查失败,必须修复后才能提交
- 不允许使用 `--no-verify` 跳过检查
- 不允许提交带有已知错误的代码
- 检查失败时,必须查看具体错误并修复

**自动化工具**:
```bash
# 执行三项检查
ruff format .
ruff check src/ tests/ --fix
mypy src/
pytest tests/
```

#### 3. 提交消息规范 (Conventional Commits)
**格式**: `<类型>(<范围>): <描述>`

**类型** (必选):
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式化 (不影响功能)
- `refactor`: 重构 (不修复 bug,不添加功能)
- `test`: 测试相关
- `chore`: 构建/工具相关
- `perf`: 性能优化

**范围** (可选但推荐):
- 模块名称: `token`, `storage`, `config`, `cli`, `core`, `utils` 等
- 功能域: `messaging`, `clouddoc`, `contact` 等

**描述** (必选):
- 清晰简洁 (≤ 50 字符为佳)
- 使用祈使句 ("添加"而非"添加了")
- 中文或英文保持一致
- 首字母小写

**正文** (可选):
- 详细说明变更内容
- 说明变更原因
- 说明影响范围
- 空行分隔标题和正文

**脚注** (可选):
- `Closes #123` - 关闭 Issue
- `Fixes #456` - 修复 Issue
- `Refs #789` - 相关 Issue
- `BREAKING CHANGE:` - 破坏性变更 (必须说明)

**示例**:
```
feat(token): 实现 Token 自动刷新机制

- 添加刷新阈值配置 (默认 80%)
- 实现双重检查锁防止重复刷新
- 添加刷新失败重试机制 (最多 3 次)

Closes #42
```

```
fix(storage): 修复 PostgreSQL 连接池泄漏

连接未正确释放导致池耗尽,现已修复:
- 使用 context manager 确保连接释放
- 添加连接超时检测
- 增加连接池监控日志

Fixes #127
```

```
docs(readme): 更新安装说明

添加 Docker 安装方式和常见问题解答
```

#### 4. Push 规范
**强制要求**:
- Push 必须**明确指令**执行,不允许自动推送
- **必须指定远程**: 明确 `origin` 或其他远程名称
- **必须指定分支**: 明确分支名称,不使用简写
- **Agent/脚本禁止自动 push**: 必须由用户明确授权

**正确示例**:
```bash
✅ git push origin feature/token-refresh
✅ git push origin main --tags
✅ git push origin develop
```

**错误示例**:
```bash
❌ git push                    # 缺少远程和分支
❌ git push origin              # 缺少分支
❌ 脚本自动执行 push            # 必须用户明确指令
```

**特殊情况**:
- **首次推送**: 使用 `-u` 设置上游 `git push -u origin feature/xxx`
- **强制推送**: 需充分理由,使用 `--force-with-lease` 而非 `--force`
- **推送标签**: 明确指定 `--tags` 或具体标签名

**理由**: 明确 push 操作避免:
- 误推送未完成代码到主分支
- 误推送敏感信息或配置
- 团队成员之间的推送冲突
- 自动化脚本的意外推送

#### 5. 完整工作流示例

**标准提交流程**:
```bash
# 1. 格式化代码 (git add 前)
ruff format .

# 2. 暂存更改
git add src/ tests/ docs/

# 3. 代码质量检查 (git commit 前)
ruff check src/ tests/ --fix
mypy src/
pytest tests/ --cov=src

# 4. 提交代码 (Conventional Commits)
git commit -m "feat(token): 实现自动刷新机制"

# 5. 推送代码 (需明确指令)
git push origin feature/token-refresh
```

**使用自动化脚本**:
```bash

# 检查通过后提交
git add .
git commit -m "feat(token): 实现自动刷新"

# 手动推送 (需明确指令)
git push origin feature/token-refresh
```

**理由**: Git 提交规范确保:
- **代码质量**: 格式化和检查在源头拦截问题
- **提交一致**: 规范消息便于追踪和自动化 (生成 CHANGELOG)
- **团队协作**: 统一流程降低协作成本
- **安全可控**: 明确 push 避免误操作

---

## 实施要求

### 强制检查点

每个功能开发必须通过以下检查:

1. **设计阶段**:
   - [ ] 技术栈符合原则 I
   - [ ] 模块依赖关系无循环 (原则 III)
   - [ ] 响应结构设计符合原则 IV
   - [ ] 设计文档遵循闭环操作 (原则 X)

2. **开发阶段**:
   - [ ] 测试先行完成 (原则 VIII)
   - [ ] 代码质量门禁通过 (原则 II)
   - [ ] 所有公共 API 包含标准 Docstring (原则 II)
   - [ ] 无硬编码凭据 (原则 VII)
   - [ ] 代码文件在原地迭代更新 (原则 X)
   - [ ] Git 提交前完成三项检查 (原则 XI)

3. **代码审查阶段**:
   - [ ] 环境配置正确隔离 (原则 VI)
   - [ ] 敏感信息处理符合原则 V 和 VII
   - [ ] Docstring 格式符合标准 (原则 II)
   - [ ] 中文文档完整 (原则 IX)
   - [ ] 无冗余或重复文件 (原则 X)
   - [ ] 提交消息符合 Conventional Commits (原则 XI)
   - [ ] 代码格式化和质量检查已通过 (原则 XI)

### 复杂性豁免流程

如果某个设计需要违反非妥协原则 (III、VII、VIII、X、XI),必须:

1. 在设计文档的 **Complexity Tracking** 章节中详细记录:
   - 违反的具体原则
   - 为何必须违反 (技术或业务约束)
   - 更简单方案为何不可行
   - 风险缓解措施

2. 获得技术负责人书面批准
3. 在代码中添加显著注释说明例外情况

---

## 治理规则

### 宪章修订流程

1. **提议**: 任何团队成员可提出修订建议,需包含:
   - 修订理由和背景
   - 影响范围评估
   - 迁移计划 (如有破坏性变更)

2. **审查**: 技术委员会审查提议,评估:
   - 是否与现有原则冲突
   - 实施可行性
   - 团队共识程度

3. **批准**: 需技术委员会 2/3 多数通过

4. **发布**: 更新宪章版本,通知全体成员,更新相关模板

### 版本控制策略

- **主版本 (MAJOR)**: 删除或重新定义原则,破坏性变更
- **次版本 (MINOR)**: 新增原则或重要章节
- **补丁版本 (PATCH)**: 澄清措辞、修正错误、非语义变更

### 合规审查

- 每个 PR 必须通过宪章合规检查
- 季度审查原则执行情况,识别系统性违规
- 年度回顾宪章有效性,评估是否需要修订

### 开发指导

运行时开发指导请参考:
- 功能规范: `/specs/[###-feature-name]/spec.md`
- 实施计划: `/specs/[###-feature-name]/plan.md`
- 任务清单: `/specs/[###-feature-name]/tasks.md`

---

**版本**: 1.1.0 | **批准日期**: 2026-01-15 | **最后修订**: 2026-01-15
