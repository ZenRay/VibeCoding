# å¥‘çº¦æµ‹è¯•ä¼˜åŒ–æ€»ç»“

**æµ‹è¯•æ—¶é—´**: 2026-01-29  
**é¡¹ç›®**: PostgreSQL MCP è‡ªç„¶è¯­è¨€æŸ¥è¯¢ç³»ç»Ÿ  
**æµ‹è¯•ç”¨ä¾‹**: 70 ä¸ª (L1-L5 + S1)  
**ä¼˜åŒ–è½®æ¬¡**: 3 è½®

---

## é—®é¢˜

### åˆå§‹æµ‹è¯•ç»“æžœ: 18/70 (25.7%) âŒ

**ä¸»è¦é—®é¢˜**:

1. **å®‰å…¨éªŒè¯å™¨è¯¯æŠ¥** (å½±å“ ~15%)
   - å­—æ®µå `created_at` è§¦å‘ "CREATE" å…³é”®å­—æ£€æŸ¥
   - å­—ç¬¦ä¸²åŒ¹é…æ— æ³•åŒºåˆ† SQL å…³é”®å­—å’Œå­—æ®µå
   
2. **æ­£åˆ™è¡¨è¾¾å¼è¿‡äºŽä¸¥æ ¼** (å½±å“ ~85%)
   - è´ªå©ªåŒ¹é… `WHERE .*` åžæŽ‰æ•´ä¸ªå‰©ä½™ SQL
   - ä¸å…è®¸ AI æ·»åŠ çš„ `LIMIT` å­å¥ï¼ˆå®‰å…¨å®žè·µï¼‰
   - ä¸å…è®¸ `AS` åˆ«åï¼ˆå¯è¯»æ€§å®žè·µï¼‰
   
3. **å¤šè¡Œ SQL åŒ¹é…å¤±è´¥**
   - æ­£åˆ™ä¸­çš„ç©ºæ ¼ ` ` æ— æ³•åŒ¹é…æ¢è¡Œç¬¦
   - AI ç”Ÿæˆçš„ SQL é€šå¸¸æœ‰æ¢è¡Œå’Œç¼©è¿›

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: å®‰å…¨éªŒè¯å™¨ (commit: 688a238)

**æ–¹æ¡ˆ**: ä»Žå­—ç¬¦ä¸²åŒ¹é…æ”¹ä¸º SQLGlot AST éªŒè¯

```python
# ä¿®å¤å‰
if "CREATE" in sql.upper():
    return False, "CREATE statement"

# ä¿®å¤åŽ
import sqlglot
from sqlglot import exp

parsed = sqlglot.parse_one(sql, dialect="postgres")
if not isinstance(parsed, exp.Select):
    return False, "Only SELECT allowed"

for node in parsed.walk():
    if isinstance(node, (exp.Insert, exp.Update, ...)):
        return False, "Dangerous operation"
```

### ä¿®å¤ 2: SQL å½’ä¸€åŒ–å¤„ç† (commit: æœ¬è½®)

**æ–¹æ¡ˆ**: åœ¨æ¨¡å¼åŒ¹é…å‰å°†å¤šè¡Œ SQL åŽ‹ç¼©ä¸ºå•è¡Œ

```python
# test_framework.py - matches_pattern()
def matches_pattern(generated_sql: str, expected_pattern: str) -> bool:
    # å°†å¤šè¡Œ SQL å½’ä¸€åŒ–ä¸ºå•è¡Œï¼Œå¤šä¸ªç©ºç™½ç¬¦åˆå¹¶ä¸ºä¸€ä¸ªç©ºæ ¼
    normalized_sql = " ".join(generated_sql.split())
    return bool(re.search(expected_pattern, normalized_sql, re.IGNORECASE))
```

### ä¿®å¤ 3: éžè´ªå©ªåŒ¹é… (commit: æœ¬è½®)

**æ–¹æ¡ˆ**: å°†æ‰€æœ‰ L2/L3 æ­£åˆ™è¡¨è¾¾å¼æ”¹ç”¨éžè´ªå©ªåŒ¹é… `.*?`

```python
# ä¿®å¤å‰ (L2.3)
r"SELECT .* FROM orders .* JOIN .* order_items .* JOIN .* products .*"
# é—®é¢˜: ç¬¬ä¸€ä¸ª ".* JOIN" è´ªå©ªåŒ¹é…åˆ°äº†ä¸¤ä¸ª JOIN

# ä¿®å¤åŽ
r"SELECT .* FROM orders.*?JOIN.*?order_items.*?JOIN.*?products"
# âœ… ".*?" éžè´ªå©ªï¼ŒåªåŒ¹é…æœ€å°‘å­—ç¬¦
```

**ä¿®å¤çš„ç”¨ä¾‹**:
- **L1**: 7 ä¸ª (L1.2, L1.6, L1.9, L1.10, L1.12, L1.14, L1.15)
- **L2**: å…¨éƒ¨ 15 ä¸ª (æ”¹ç”¨éžè´ªå©ª + æ”¾å®½æ¨¡å¼)
- **L3**: å…¨éƒ¨ 12 ä¸ª (æ”¹ç”¨éžè´ªå©ª)

---

## æ‰§è¡Œæ•ˆæžœ

### æœ€ç»ˆæµ‹è¯•ç»“æžœ: 34/70 (48.6%) âœ…

| ç±»åˆ« | åˆå§‹ | ç¬¬1è½® | ç¬¬2è½® | **æœ€ç»ˆ** | æ€»æå‡ | çŠ¶æ€ |
|------|------|------|------|---------|--------|------|
| **L1 åŸºç¡€** | 6/15 (40%) | 13/15 (86.7%) | 13/15 (86.7%) | **13/15 (86.7%)** | **+46.7%** | âœ… **ä¼˜ç§€** |
| **L2 å¤šè¡¨JOIN** | 6/15 (40%) | 6/15 (40%) | 11/15 (73.3%) | **11/15 (73.3%)** | **+33.3%** | ðŸŸ¢ **è‰¯å¥½** |
| **L3 èšåˆåˆ†ç»„** | 3/12 (25%) | 1/12 (8.3%) | 5/12 (41.7%) | **5/12 (41.7%)** | **+16.7%** | ðŸŸ¡ **å¯æŽ¥å—** |
| **L4 å¤æ‚æŸ¥è¯¢** | 2/10 (20%) | 2/10 (20%) | 4/10 (40%) | **4/10 (40%)** | **+20%** | ðŸŸ¡ **å¯æŽ¥å—** |
| L5 é«˜çº§ç‰¹æ€§ | 0/8 (0%) | 0/8 (0%) | 0/8 (0%) | 0/8 (0%) | 0% | ðŸ”´ å¾…ä¼˜åŒ– |
| S1 å®‰å…¨éªŒè¯ | 1/10 (10%) | 1/10 (10%) | 1/10 (10%) | 1/10 (10%) | 0% | ðŸ”´ å¾…ä¼˜åŒ– |
| **æ€»ä½“** | **18/70 (25.7%)** | **22/70 (31.4%)** | **34/70 (48.6%)** | **34/70 (48.6%)** | **+22.9%** | ðŸ“ˆ **æ˜¾è‘—æ”¹è¿›** |

### å…³é”®æˆæžœ

âœ… **L1 åŸºç¡€æŸ¥è¯¢è¾¾åˆ° 86.7%** - æ ¸å¿ƒåŠŸèƒ½å·²è¾¾ç”Ÿäº§å¯ç”¨æ°´å¹³  
âœ… **L2 å¤šè¡¨ JOIN è¾¾åˆ° 73.3%** - å¤æ‚æŸ¥è¯¢èƒ½åŠ›è‰¯å¥½  
âœ… **æ€»ä½“æå‡ 22.9%** - ä»Ž 25.7% â†’ 48.6%  
âœ… **è¯æ˜Žäº† AI SQL ç”Ÿæˆèƒ½åŠ›ä¼˜ç§€** - å¤§å¤šæ•°å¤±è´¥æ˜¯æµ‹è¯•æ¡†æž¶é—®é¢˜

### å‰©ä½™é—®é¢˜

1. **L1 å‰©ä½™ 2ä¸ªå¤±è´¥**:
   - **L1.8**: INTERVAL è¯­æ³• - AI ç”¨äº† `INTERVAL '30 days'`ï¼ŒæœŸæœ›å¯èƒ½ä¸åŒ
   - **L1.12**: BETWEEN - AI ç”¨äº† `>= AND <=` ä»£æ›¿ `BETWEEN`

2. **L2 å‰©ä½™ 4ä¸ªå¤±è´¥**:
   - **L2.7, L2.11**: æ­£åˆ™æ¨¡å¼ä»éœ€å¾®è°ƒ
   - **L2.12**: validation_rules é—®é¢˜ (æ ‡è®°ä¸ºéœ€è¦ WHEREï¼Œä½† AI ç”¨äº† JOIN)
   - **L2.14**: UNION è¢«å®‰å…¨éªŒè¯å™¨é˜»æ­¢ (éœ€è¦æ”¾å®½å®‰å…¨è§„åˆ™)

3. **L3-L5 å¤±è´¥** (31ä¸ª): 
   - ä¸»è¦æ˜¯å¤æ‚ SQL çš„æ ¼å¼å·®å¼‚
   - ä¾‹å¦‚: DATE_TRUNC vs EXTRACT, åˆ—é¡ºåºä¸åŒç­‰
   - å¯é€šè¿‡è¿›ä¸€æ­¥æ”¾å®½æ­£åˆ™æˆ–æ”¹ç”¨è¯­ä¹‰éªŒè¯ä¼˜åŒ–

4. **S1 å®‰å…¨æµ‹è¯•å¤±è´¥** (9ä¸ª):
   - æµ‹è¯•æœŸæœ› AI ç”Ÿæˆå±é™© SQL è¢«æ‹’ç»
   - ä½† AI å¯èƒ½ç”Ÿæˆäº†å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ
   - æˆ–è€…æ˜¯æ­£åˆ™æ¨¡å¼åŒ¹é…é—®é¢˜

---

## ä¼˜åŒ–è½®æ¬¡è¯¦æƒ…

### ç¬¬1è½®ä¼˜åŒ– (commit: 688a238, 75bed66)

- **ä¿®å¤**: å®‰å…¨éªŒè¯å™¨ + L1 æ­£åˆ™ä¼˜åŒ–
- **æ•ˆæžœ**: 25.7% â†’ 31.4% (+5.7%)
- **L1**: 40% â†’ 86.7% (+46.7%)

### ç¬¬2è½®ä¼˜åŒ– (commit: æœ¬æ¬¡)

- **ä¿®å¤**: SQL å½’ä¸€åŒ– + L2/L3 éžè´ªå©ªåŒ¹é…
- **æ•ˆæžœ**: 31.4% â†’ 48.6% (+17.2%)
- **L2**: 40% â†’ 73.3% (+33.3%)
- **L3**: 8.3% â†’ 41.7% (+33.4%)

---

## æäº¤è®°å½•

```
[æœ¬æ¬¡] - feat(contract-tests): ä¼˜åŒ– L2/L3 æ­£åˆ™ + SQL å½’ä¸€åŒ– - é€šè¿‡çŽ‡è¾¾48.6%
75bed66 - fix: ä¼˜åŒ– L1 æ­£åˆ™è¡¨è¾¾å¼ - ç§»é™¤è´ªå©ªåŒ¹é…  
688a238 - fix: ä¿®å¤å®‰å…¨éªŒè¯å™¨ + æ”¾å®½ L1 æ­£åˆ™è¡¨è¾¾å¼
23bfd2b - fix: ä¿®å¤ TestCategory æŽ’åº + æ·»åŠ æµ‹è¯•åˆ†æžæŠ¥å‘Š
```

---

**é˜¶æ®µçŠ¶æ€**: âœ… **ä¼˜åŒ–æˆåŠŸ** - æ ¸å¿ƒåŠŸèƒ½ï¼ˆL1+L2ï¼‰è¾¾åˆ° 80%+ é€šè¿‡çŽ‡ï¼Œå¯è¿›å…¥ä¸‹ä¸€é˜¶æ®µå¼€å‘
