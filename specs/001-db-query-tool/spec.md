# Feature Specification: 数据库查询工具

**Feature Branch**: `001-db-query-tool`  
**Created**: 2026-01-10  
**Last Updated**: 2026-01-10 (PR 评审后修订)  
**Status**: Ready for Development  
**Input**: User description: "数据库查询工具，用户可以添加数据库连接，系统获取 metadata 并展示表和视图信息，支持手动 SQL 查询和自然语言生成 SQL"

## Clarifications

### Session 2026-01-10

- Q: 如何存储敏感的数据库认证凭据？ → A: 明文存储（适用于开发环境和受信任的本地使用场景）
- Q: 系统何时自动刷新数据库元数据？ → A: 检测到元数据版本变化时提示用户刷新
- Q: 单个 SQL 查询的最大执行超时时间是多少？ → A: 30 秒
- Q: 是否需要保存用户的查询历史记录？ → A: 仅保存当前会话的查询历史（关闭应用后清空）
- Q: 当单个表格单元格包含大量文本时，如何显示？ → A: 截断显示（100 字符），悬停时显示完整内容的 tooltip

### Session 2026-01-10 (评审后补充)

- Q: 本地存储的大小和清理策略？ → A: 最大 100MB，超出时自动清理最旧的元数据缓存
- Q: 查询历史的数量限制？ → A: 当前会话最多保存 50 条查询历史
- Q: 支持的数据库版本范围？ → A: PostgreSQL 10+, MySQL 5.7+, SQLite 3.8+
- Q: 元数据版本变化的检测方式？ → A: 通过比较数据库系统表的最后修改时间或表数量变化
- Q: 并发查询的管理策略？ → A: 串行执行，同一时间仅允许一个查询执行，其他查询进入队列等待
- Q: SQL 编辑器需要哪些基本功能？ → A: 文本输入、基本复制粘贴、查询历史选择，不需要语法高亮或自动补全

### Session 2026-01-10 (安全性与数据模型评审补充)

- Q: 连接 URL 中的密码在界面展示时如何处理？ → A: 密码字段在界面显示时应遮蔽为 `***`，用户可点击"显示"按钮临时查看
- Q: AI 生成的 SQL 是否与手动输入 SQL 使用相同的验证规则？ → A: 是，所有 SQL（无论来源）都必须通过相同的语法验证和语句类型检查（仅允许 SELECT）
- Q: 连接名称的验证规则是什么？ → A: 连接名称仅允许字母、数字、下划线和连字符，长度 1-100 字符，格式：`^[a-zA-Z0-9_-]+$`
- Q: 日期时间字段使用什么时区？ → A: 系统内部统一使用 UTC 时间存储和处理，前端展示时根据用户本地时区转换
- Q: API 响应中可选字段为空时如何表示？ → A: 可选字段为空时返回 `null`，不省略字段（便于前端类型检查）
- Q: 数据库模型变更时如何处理现有数据？ → A: 使用 Alembic 管理数据库迁移，确保向后兼容

### Session 2026-01-10 (PR 评审补充)

- Q: SQL 查询和自然语言提示的输入长度限制是多少？ → A: SQL 查询最大 10000 字符，自然语言提示最大 1000 字符
- Q: NULL 值在查询结果表格中如何显示？ → A: NULL 值显示为斜体灰色的 `null` 文本，与空字符串区分
- Q: 多字节字符（如中文）在截断时如何计算？ → A: 按 Unicode 字符计算，非字节。一个中文字符算一个字符
- Q: AI 服务的 API 密钥如何配置？ → A: 通过环境变量 `OPENAI_API_KEY` 配置，应用启动时读取
- Q: 连接列表的默认排序规则是什么？ → A: 按创建时间降序排列（最新添加的连接显示在最前面）
- Q: 队列中等待的查询超时如何处理？ → A: 队列中等待超过 60 秒的查询自动取消，显示"等待超时"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 数据库连接管理 (Priority: P1)

用户需要添加数据库连接字符串（支持 PostgreSQL、MySQL、SQLite），系统验证连接并保存。用户可以查看所有已添加的数据库连接列表，选择其中一个进行查询操作。

**Why this priority**: 这是系统的基础功能，没有数据库连接就无法进行任何查询操作。这是最小可行产品（MVP）的核心。

**Independent Test**: 可以通过添加一个测试数据库连接并成功连接来验证。用户可以看到连接列表并选择数据库，即使没有查询功能也能展示价值（连接管理器）。

**Acceptance Scenarios**:

1. **Given** 用户在首页, **When** 用户输入有效的数据库连接字符串（如 `postgresql://user:pass@localhost:5432/mydb`）并点击"添加", **Then** 系统验证连接成功并将该连接保存到本地存储，显示在连接列表中，并显示安全提示"连接凭据以明文存储，仅适用于开发环境"
2. **Given** 用户输入了无效的连接字符串, **When** 用户点击"添加", **Then** 系统显示连接失败的具体错误信息（如"网络不可达"、"认证失败"、"数据库不存在"），不保存该连接
3. **Given** 用户已添加多个数据库连接, **When** 用户查看连接列表, **Then** 系统显示所有已保存的数据库连接（包括数据库类型、主机、数据库名等信息），密码字段显示为遮蔽状态 `***`
4. **Given** 用户在连接列表中, **When** 用户点击某个连接, **Then** 系统切换到该数据库并准备进行查询操作
5. **Given** 用户选择一个已保存的连接, **When** 用户点击"编辑"按钮, **Then** 系统显示编辑表单，允许用户修改连接信息（主机、端口、数据库名、凭据），保存后重新验证连接

---

### User Story 2 - 数据库元数据浏览 (Priority: P1)

用户选择一个已连接的数据库后，系统自动获取并展示该数据库的所有表（tables）和视图（views）的元数据信息，包括表名、列名、数据类型等。这些元数据会被缓存到本地存储以便后续快速访问。

**Why this priority**: 元数据浏览是用户理解数据库结构的关键，也是后续 SQL 查询（手动或 AI 生成）的基础。与 P1 的连接管理共同构成 MVP。

**Independent Test**: 连接到一个包含多个表的测试数据库，验证系统能够正确展示所有表和列的信息。即使没有查询功能，用户也能通过元数据浏览器了解数据库结构。

**Acceptance Scenarios**:

1. **Given** 用户已选择一个数据库连接, **When** 用户进入元数据浏览页面, **Then** 系统显示该数据库中所有表和视图的列表
2. **Given** 用户查看某个表的详情, **When** 用户点击展开该表, **Then** 系统显示该表的所有列名、数据类型、是否可为空等信息
3. **Given** 系统首次获取某数据库的元数据, **When** 元数据获取完成, **Then** 系统将元数据以结构化格式存储到本地存储中
4. **Given** 用户再次访问已缓存的数据库, **When** 用户查看元数据, **Then** 系统从本地存储快速加载，无需重新连接远程数据库
5. **Given** 系统检测到数据库元数据版本已变化（如表数量或结构变更）, **When** 用户访问该数据库, **Then** 系统显示提示消息建议用户刷新元数据
6. **Given** 系统提取元数据时部分表失败（如权限不足）, **When** 元数据提取完成, **Then** 系统显示成功提取的表和视图，并显示警告消息列出无法访问的表

---

### User Story 3 - 手动 SQL 查询 (Priority: P2)

用户可以在 SQL 编辑器中输入 SQL 查询语句，系统验证语法（仅允许 SELECT 语句），执行查询并以表格形式展示结果。如果查询缺少行数限制，系统自动添加合理的默认限制（1000 行）。

**Why this priority**: 这是核心查询功能，满足用户直接编写 SQL 的需求。虽然重要，但在有了连接管理和元数据浏览后，才能有效使用。

**Independent Test**: 连接到测试数据库，输入一个简单的 SELECT 查询（如 `SELECT * FROM users`），验证结果正确显示。这个功能可以独立测试和部署，不依赖自然语言查询。

**Acceptance Scenarios**:

1. **Given** 用户在 SQL 编辑器中输入有效的 SELECT 查询, **When** 用户点击"执行", **Then** 系统验证语法、执行查询并以表格形式展示结果
2. **Given** 用户输入的查询不包含行数限制子句, **When** 系统执行查询前, **Then** 系统自动添加默认的行数限制（1000 行）
3. **Given** 用户输入的查询包含非 SELECT 语句（如 UPDATE、DELETE）, **When** 用户点击"执行", **Then** 系统拒绝执行并显示错误信息："仅允许 SELECT 查询"
4. **Given** 用户输入的 SQL 语法错误, **When** 系统验证查询, **Then** 系统显示具体的语法错误信息，不执行查询
5. **Given** 查询成功执行但返回空结果, **When** 系统显示结果, **Then** 系统显示"无结果"消息
6. **Given** 用户在当前会话中执行了多个查询, **When** 用户查看查询历史, **Then** 系统显示本次会话中所有已执行的查询及其状态和结果摘要（最多 50 条）
7. **Given** 用户正在执行一个查询, **When** 用户点击"取消"按钮, **Then** 系统中止查询执行并释放数据库连接，显示"查询已取消"消息

---

### User Story 4 - 自然语言生成 SQL (Priority: P3)

用户可以用自然语言描述查询需求（如"查找所有年龄大于 30 的用户"），系统使用 AI 服务结合数据库元数据生成对应的 SQL 查询，用户可以审查生成的 SQL 后再执行。

**Why this priority**: 这是增强功能，提升用户体验，但不是 MVP 必需。用户即使没有这个功能，也能通过手动 SQL 完成所有查询需求。

**Independent Test**: 输入自然语言查询"查找所有用户"，验证系统生成正确的 SELECT 查询并正确执行。这个功能独立于其他功能，可以最后开发和测试。

**Acceptance Scenarios**:

1. **Given** 用户在自然语言查询框中输入查询描述, **When** 用户点击"生成 SQL", **Then** 系统将数据库元数据作为上下文使用 AI 服务生成对应的 SQL 查询并显示在编辑器中
2. **Given** AI 服务生成了 SQL 查询, **When** 用户查看生成的 SQL, **Then** 用户可以选择直接执行或手动修改后再执行
3. **Given** AI 生成的 SQL 语法错误或不符合规范, **When** 系统验证查询, **Then** 系统显示错误并允许用户修改
4. **Given** 用户的自然语言描述不清晰, **When** AI 服务无法生成有效查询, **Then** 系统提示用户重新描述或提供更多上下文

---

### Edge Cases

- **连接断开场景**: 当用户已连接的数据库在查询时断开连接，系统应显示"连接已断开"错误，并允许用户重新连接
- **查询超时**: 当查询执行超过 30 秒时，系统应中止查询、释放数据库连接，并提示用户"查询超时（30秒）。建议：优化查询条件或添加索引"
- **超大结果集**: 即使添加了默认行数限制，如果某些查询返回的单行数据非常大（如包含大文本字段），系统应在表格单元格中截断显示（100 字符），悬停时显示完整内容的 tooltip
- **并发查询**: 系统采用串行执行策略，同一时间仅允许一个查询执行。如果用户尝试执行新查询while当前查询正在执行，新查询将显示"等待中"状态
- **特殊字符处理**: 数据库中的表名或列名包含特殊字符（空格、中文、SQL 关键字如 `SELECT`、`WHERE`）时，系统应在元数据展示和查询生成时正确转义或使用引号包裹
- **特殊数据类型**: 查询返回特殊数据类型（如二进制BLOB、JSON、XML、地理数据）时，系统应将二进制数据显示为 `[BINARY]`，将 JSON/XML 显示为格式化文本（截断规则同样适用）
- **AI 服务失败**: 当 AI 服务调用失败（网络问题、服务不可用、API 配额超限）时，系统应在自然语言查询界面显示错误提示并建议用户使用手动 SQL 查询
- **AI 生成异常 SQL**: 当 AI 生成的 SQL 不符合安全要求(如包含子查询、系统函数、不存在的表名)时,系统应拒绝执行并提示用户:"AI 生成的查询不符合安全要求。建议: 简化您的描述或使用手动 SQL"。系统应记录审计日志便于安全分析。
- **无效的元数据**: 某些数据库可能有非标准的元数据结构（如缺少系统表），系统应捕获错误并显示"无法提取元数据，该数据库可能不受支持"
- **本地存储损坏**: 应用启动时检测本地存储文件完整性，如果损坏则自动重新创建空存储，并提示用户"本地存储已重置，请重新添加数据库连接"
- **存储空间不足**: 当本地存储超过 100MB 限制时，系统应自动删除最旧的元数据缓存（保留数据库连接信息），并记录日志

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持 PostgreSQL 10+、MySQL 5.7+ 和 SQLite 3.8+ 三种数据库类型的连接字符串解析和验证。标准格式为：
  - PostgreSQL: `postgresql://user:password@host:port/database`
  - MySQL: `mysql://user:password@host:port/database`
  - SQLite: `sqlite:///path/to/database.db`
  
- **FR-002**: 系统必须在用户添加数据库连接时验证连接有效性（实际尝试连接）。连接失败时，系统必须明确区分错误类型：网络不可达、认证失败、权限拒绝、数据库不存在等，并显示相应的错误消息。

- **FR-003**: 系统必须将所有数据库连接信息（包括认证凭据）和元数据持久化存储到本地存储。凭据以明文形式存储，适用于开发环境和受信任的本地使用场景。本地存储最大容量为 100MB，超出时自动清理最旧的元数据缓存（保留连接信息）。首次添加连接时，系统必须显示安全警告："连接凭据以明文存储，仅适用于开发环境和受信任的本地使用场景"。界面展示连接信息时，密码字段必须遮蔽显示为 `***`，提供"显示密码"按钮临时显示。API 响应（`GET /api/v1/dbs`）不返回密码字段。

- **FR-004**: 系统必须能够从目标数据库中提取所有表和视图的元数据。必需字段包括：表名、列名、数据类型、是否可为空。可选字段包括：主键、外键、索引、注释。如果部分表因权限不足无法提取，系统应显示成功提取的表并显示警告消息。

- **FR-005**: 系统必须将提取的元数据转换为结构化格式（嵌套对象结构：数据库 → 表 → 列）并持久化存储到本地存储。

- **FR-006**: 系统必须提供元数据缓存机制，避免每次访问都重新查询远程数据库。系统应通过以下方式检测元数据版本变化：存储表数量和所有表名列表的 SHA-256 哈希值，每次连接时重新计算哈希值并比较变化。检测到变化时，系统应显示提示消息建议用户刷新元数据。

- **FR-007**: 系统必须验证用户输入的 SQL 查询语法正确性。验证应在查询发送到数据库前完成，并在检测到语法错误时在 1 秒内返回错误信息（包括错误位置和原因）。

- **FR-008**: 系统必须仅允许执行 SELECT 语句，拒绝 INSERT、UPDATE、DELETE、DROP、ALTER、CREATE 等修改性语句。拒绝时应显示明确的错误消息："仅允许 SELECT 查询，该操作已被阻止"。

- **FR-009**: 系统必须自动为查询添加行数限制,防止超大结果集:
  
  **自动限制规则**:
  1. **检测 LIMIT 子句**: 若用户查询已包含 LIMIT,则保留用户设置(最大不超过 10000)
  2. **聚合查询豁免**: 若查询包含聚合函数(COUNT, SUM, AVG, MAX, MIN)且无 GROUP BY,则不添加 LIMIT
  3. **默认限制**: 其他情况自动添加 `LIMIT 1000`
  
  **用户配置**:
  - 界面提供"每页行数"配置(选项: 100, 500, 1000, 5000, 10000)
  - 默认值: 1000 行
  - 配置保存在浏览器 localStorage,跨会话保留
  
  **用户提示**:
  - 当结果达到限制行数时,显示警告:"已显示前 [N] 行结果。若需查看更多数据,请在查询中添加 LIMIT 子句或调整每页行数设置。"

- **FR-010**: 系统必须将查询结果以结构化格式（包含列元数据和行数据的对象数组）返回。

- **FR-011**: 系统必须将查询结果渲染为表格形式展示。单元格内容超过 100 字符时应截断显示（按 Unicode 字符计算，非字节），悬停时通过 tooltip 显示完整内容。特殊数据类型处理：BLOB 显示为 `[BINARY]`，JSON/XML 显示为格式化文本（同样截断）。

- **FR-012**: 系统必须支持自然语言输入，并通过 AI 服务生成对应的 SQL 查询。AI 生成的 SQL 必须经过与手动输入相同的验证流程（语法检查、仅允许 SELECT）。

  **AI 输出额外验证**:
  1. **内容清洗**: 
     - 移除所有 SQL 注释(`--`, `/* */`, `#`)
     - 移除多余空白和换行
  2. **白名单验证**:
     - 仅允许 SELECT、FROM、WHERE、JOIN、GROUP BY、HAVING、ORDER BY、LIMIT 关键字
     - 禁止子查询(嵌套 SELECT)
     - 禁止系统函数(version(), current_user, database(), sleep())
  3. **表名验证**:
     - 验证引用的表名必须存在于当前数据库元数据中
     - 拒绝访问系统表(information_schema, pg_catalog, mysql.*)
  4. **审计日志**:
     - 记录原始自然语言输入和生成的 SQL
     - 记录所有被拒绝的 AI 生成 SQL 及拒绝原因

  AI 服务调用失败时，系统应在界面显示友好的错误消息并建议用户使用手动 SQL 查询。
  
  **AI 生成 SQL 被拒绝时的错误提示**: "AI 生成的 SQL 包含不安全模式,已被阻止。请尝试重新描述您的查询需求,或使用手动 SQL。"

- **FR-013**: 系统必须在生成 SQL 时将数据库元数据作为上下文传递给 AI 服务，以提高 SQL 生成的准确性。

- **FR-014**: 系统必须在 SQL 语法错误时提供清晰的错误信息，使用以下格式："语法错误：[具体错误描述]。位置：第 X 行，第 Y 列"。

- **FR-015**: 系统必须能够处理查询超时（最大 30 秒）或连接失败的情况。超时后应中止查询并释放数据库连接。错误提示格式："查询超时（30秒）。建议：优化查询条件、减少返回行数或添加索引"。

- **FR-016**: 系统必须支持用户删除已保存的数据库连接。删除前应显示确认对话框："确认删除连接 '[连接名称]'？该操作无法撤销"。

- **FR-017**: 系统必须支持用户手动刷新数据库元数据（重新从远程数据库获取）。当系统检测到元数据版本变化时，应主动显示提示横幅："数据库结构已更改，建议刷新元数据"，提供"刷新"按钮。

- **FR-018**: 系统必须在当前会话中保存查询历史，包括查询文本、执行时间、状态和结果摘要。最多保存 50 条查询历史，超出时删除最旧的记录。查询历史在应用关闭后不持久化保存。

- **FR-019**: 系统必须支持用户编辑已保存的数据库连接信息（主机、端口、数据库名、凭据）。编辑保存后，系统应重新验证连接。如果验证失败，系统应保留原连接信息并显示错误。

- **FR-020**: 系统必须支持用户在查询执行过程中取消查询。点击"取消"按钮后，系统应立即中止查询执行、释放数据库连接，并显示"查询已取消"消息。

- **FR-021**: 系统必须提供基本的 SQL 编辑器，支持：文本输入、复制粘贴、从查询历史选择。不要求语法高亮或自动补全功能。

- **FR-022**: 系统应用启动时间必须在 3 秒内完成（从启动到显示主界面并加载已保存的数据库连接列表）。此指标仅计算本地存储读取和界面渲染时间，不包含远程数据库连接验证或元数据提取时间（这些操作应异步进行）。

- **FR-023**: 元数据缓存的内存使用不应超过 50MB。系统应监控缓存大小，超出时优先清理最少使用的数据库元数据。

- **FR-024**: 数据库连接名称必须符合以下验证规则：仅允许字母（a-z, A-Z）、数字（0-9）、下划线（_）和连字符（-），长度 1-100 字符，正则表达式：`^[a-zA-Z0-9_-]+$`。不符合规则的名称应在保存前显示验证错误。

- **FR-025**: 系统必须使用 UTC 时间存储所有日期时间字段（创建时间、更新时间、缓存时间等）。前端展示时应根据用户浏览器时区进行本地化转换。
  
  **时间比较规则**:
  - 所有时间戳比较必须在 UTC 时区进行,禁止在本地时区比较
  - 缓存时间戳存储格式: ISO 8601 UTC 格式 (例: `2026-01-10T10:30:00Z`)
  - 时间戳比较使用 Unix 时间戳(秒级整数)进行数值比较
  - 前端接收到 UTC 时间后仅用于展示,不参与业务逻辑判断

- **FR-026**: API 响应中的可选字段为空时，必须返回 `null` 值而非省略该字段。这确保前端可以进行可靠的类型检查。

- **FR-027**: 系统必须使用数据库迁移工具（如 Alembic）管理本地存储模式的版本变更。每次模式变更必须创建迁移脚本，支持向前和向后迁移。

- **FR-028**: SQL 查询输入的最大长度为 10000 字符，自然语言提示输入的最大长度为 1000 字符。超过限制时，系统应在输入框下方显示错误提示，禁止提交。

- **FR-029**: 查询结果表格中，数据库 NULL 值必须显示为斜体灰色的 `null` 文本，与空字符串（显示为空白单元格）明确区分。这有助于用户识别真正的空值。

- **FR-030**: AI 服务配置必须通过环境变量 `OPENAI_API_KEY` 提供。应用启动时读取此环境变量。如果环境变量未设置，自然语言查询功能应禁用并显示提示："AI 服务未配置，请设置 OPENAI_API_KEY 环境变量"。

- **FR-031**: 数据库连接列表必须按创建时间降序排列（最新添加的连接显示在最前面）。

- **FR-032**: 当用户尝试执行新查询但存在正在执行的查询时，新查询进入等待队列。队列中等待超过 60 秒的查询应自动取消，并显示"等询等待超时，请稍后重试"消息。

- **FR-033**: 元数据传递给 AI 服务时，必须以简洁的 JSON 格式表示（表名和列名列表）。单次请求的元数据上下文不超过 4000 tokens（约 16000 字符）。如果元数据超出限制，应优先包含用户最近访问的表，并在提示中说明"部分表未包含在上下文中"。

- **FR-034**: 系统必须实施多层 SQL 注入防护:
  
  **1. 语法解析层(sqlglot)**:
  - 验证 SQL 语句解析后仅包含单个 SELECT 语句
  - 拒绝包含多语句分隔符(`;`)的输入
  - 拒绝包含 SQL 注释(`--`, `/* */`, `#`)的输入
  - 拒绝包含 UNION、INTO OUTFILE、LOAD_FILE 等危险关键字的 SELECT 语句
  
  **2. 数据库执行层**:
  - 使用数据库驱动的参数化查询(仅适用于动态值)
  - 设置数据库连接为只读模式(READ ONLY transaction)
  - 限制数据库用户权限为仅 SELECT 权限
  
  **3. 结果验证层**:
  - 验证查询返回的列数和列名与预期一致
  - 检测异常大的结果集(>1000 行时警告)
  
  **错误提示格式**: "检测到不安全的 SQL 模式:[模式名称]。仅允许安全的 SELECT 查询。"

- **FR-035**: 系统必须实施元数据操作与查询执行的互斥保护:
  
  **并发控制规则**:
  1. **元数据刷新中**: 阻止新查询提交,显示提示"元数据刷新中,请稍候..."
  2. **查询执行中**: 
     - 允许查看元数据(只读)
     - 阻止元数据刷新,显示提示"查询执行中,无法刷新元数据"
     - 提供"刷新后自动执行"选项
  3. **队列等待中的查询**: 用户发起元数据刷新时,清空查询队列并提示用户确认
  
  **一致性保证**:
  - 每个查询执行前锁定当前元数据快照
  - 查询使用的元数据版本记录在查询历史中
  - 元数据刷新完成后,提示用户"数据库结构已更新,建议重新执行查询"

### Key Entities

- **数据库连接 (Database Connection)**: 表示一个用户添加的数据库连接，包含连接配置信息、数据库类型（PostgreSQL/MySQL/SQLite）、数据库版本、主机名、端口、数据库名、认证凭据（以明文形式存储）等信息。需要持久化存储。适用于开发环境和受信任的本地使用场景。

- **数据库元数据 (Database Metadata)**: 表示某个数据库的结构信息，包括所有表和视图的名称、每个表的列名、数据类型、主键、外键、索引等。以结构化格式（嵌套对象）存储在本地，与对应的数据库连接关联。单个数据库元数据缓存不超过 5MB。

- **SQL 查询 (SQL Query)**: 表示用户输入或 AI 生成的 SQL 查询语句，包含查询文本、目标数据库、执行状态（待执行/执行中/成功/失败/已取消）、执行时间、返回的行数、错误信息等。查询历史仅在当前会话中保存（最多 50 条），关闭应用后清空。

- **查询结果 (Query Result)**: 表示 SQL 查询的执行结果，包含结果数据（结构化格式：列元数据 + 行数组）、列信息、行数、执行时长等。以表格形式展示给用户，长文本字段在单元格中截断显示（100 字符），悬停时通过 tooltip 查看完整内容。

### Dependencies & Assumptions

**外部依赖**:
- **AI 服务**: 系统依赖外部 AI 服务（如 OpenAI API）用于自然语言生成 SQL 功能。假设 API 遵循标准的请求-响应模式，响应时间通常在 10 秒内。服务不可用时，该功能应优雅降级，不影响其他功能。

- **数据库驱动**: 系统需要支持 PostgreSQL、MySQL、SQLite 的数据库驱动程序。假设驱动程序可以通过标准包管理器安装。

- **网络连接**: 连接远程数据库（PostgreSQL、MySQL）需要网络可用性。假设网络环境稳定，延迟在可接受范围内（< 500ms）。

**用户假设**:
- **SQL 知识**: 假设目标用户具备基本的 SQL 知识，能够编写简单的 SELECT 查询。自然语言查询功能作为辅助，而非替代手动 SQL。

- **使用环境**: 假设系统运行在桌面环境（Windows、macOS、Linux），屏幕分辨率至少为 1280x720。不针对移动设备优化。

- **安全环境**: 假设系统运行在受信任的本地环境或开发环境中，明文存储凭据的风险可接受。不适用于生产环境或多用户共享环境。

**目标用户群体**:
- **主要用户**: 开发者、数据分析师、运维人员
- **技术能力**: 熟悉 SQL、使用桌面环境、具备基本英语/中文能力
- **访问环境**: 有正常视觉和精细运动控制能力,使用鼠标和键盘
- **语言环境**: 中文或英文用户(界面和错误提示使用中文,SQL 使用英文)

**明确排除的用户群体**:
- 视觉障碍用户(需屏幕阅读器)
- 运动障碍用户(仅能使用键盘)
- 其他语言用户(需完整国际化支持)

**风险确认**: 
- 该工具定位为内部开发工具,目标用户群体明确
- 如未来需面向更广泛用户,需投入可访问性和国际化改造

**技术假设与未来扩展限制**:
- **本地存储假设**: 
  - 当前版本: 本地 SQLite 文件存储,单机部署,假设本地文件系统可用且有至少 100MB 的可用空间
  - 限制: 不支持多设备同步、远程访问
  - 未来扩展考虑: 设计数据访问层接口,支持替换为 PostgreSQL/云数据库

- **单用户假设**:
  - 当前版本: 无用户认证、无并发控制、无权限管理,假设单用户使用场景,不需要处理多用户并发访问同一数据库连接的情况
  - 限制: 不支持团队协作、审计日志
  - 未来扩展考虑: 数据库连接和查询历史可增加 user_id 字段

- **本地部署假设**:
  - 当前版本: 桌面应用(或本地 Web 服务)
  - 限制: 不支持云端部署、容器化多实例
  - 未来扩展考虑: 使用环境变量配置存储后端

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在 30 秒内成功添加一个数据库连接并看到连接列表
- **SC-002**: 系统能够在 5 秒内完成中小型数据库（100 张表以内）的元数据提取和展示
- **SC-003**: 用户能够在 3 秒内执行一个简单的 SELECT 查询并看到表格化的结果（假设结果集不超过 1000 行）。复杂查询的最大超时限制为 30 秒。
- **SC-004**: 系统能够正确拒绝 100% 的非 SELECT 语句（如 UPDATE、DELETE），并提供清晰错误信息
- **SC-005**: AI 生成的 SQL 查询在简单场景下有 90% 以上的语法正确率。简单场景定义为：单表 SELECT 查询，最多 3 个 WHERE 条件，无子查询或 JOIN。测试方法：使用至少 100 个预定义的自然语言测试用例进行验证。
- **SC-006**: 用户在使用自然语言查询时，能够在 10 秒内获得生成的 SQL 查询
- **SC-007**: 系统能够缓存元数据，使得第二次访问同一数据库的元数据时，加载时间减少至 1 秒以内
- **SC-008**: 90% 的用户能够在首次使用时，不借助文档或帮助，成功完成"添加连接 → 浏览元数据 → 执行查询"的完整流程。测试方法：通过至少 10 名用户的可用性测试进行验证。
- **SC-009**: 系统在处理语法错误的 SQL 时，能够在 1 秒内返回错误信息，不会发送到数据库执行
- **SC-010**: 应用启动时间不超过 3 秒，从启动到显示主界面并加载连接列表

## Out of Scope *(explicitly excluded)*

以下功能明确**不**包含在当前版本中：

- **查询结果导出**: 当前版本不支持将查询结果导出为 CSV、JSON 或其他格式。用户需要通过复制粘贴或截图保存结果。**限制原因**: 默认限制 1000 行查询结果,若需处理更大数据集,建议使用专业 SQL 客户端。**未来考虑**: 如用户反馈强烈,可在 v2 版本中添加导出功能。

- **高级 SQL 编辑器功能**: 不提供语法高亮、自动补全、代码折叠等高级编辑器功能。仅提供基本文本输入。

- **完整的键盘导航**: 不保证所有功能都支持纯键盘操作，鼠标仍然是主要交互方式。

- **可访问性(Accessibility)**: 不提供 ARIA 标签、屏幕阅读器支持、完整键盘导航、高对比度模式等无障碍功能。**理由**: 定位为开发者内部工具,目标用户群体不包含需辅助技术的用户。**合规风险警告**: 若未来部署到需满足无障碍合规要求的环境(如美国联邦政府 Section 508、欧盟 EAA),需进行可访问性改造。
  
- **国际化(i18n)**: 界面和错误提示使用中文,仅支持中英文用户。不提供多语言切换、RTL 布局、本地化日期格式等功能。**理由**: 工具面向国内开发团队,暂无国际化需求。

- **移动设备支持**: 不针对手机或平板电脑优化，不提供响应式布局。仅支持桌面浏览器（最小分辨率 1280x720）。

- **多用户与团队协作**: 不支持用户认证、权限管理、共享连接、协作查询等功能。**未来扩展考虑**: 设计时已预留扩展点(数据模型可增加 user_id),但当前版本不实现。

- **云端部署与水平扩展**: 不支持分布式部署、负载均衡、跨实例缓存同步。架构设计基于单实例场景。

- **多用户协作**: 不支持多用户同时访问或编辑同一数据库连接。

- **查询可视化**: 不提供图表、报表或数据可视化功能。

- **首次使用引导**: 不提供新手教程、工具提示或引导流程。假设用户通过文档学习使用方法。

- **数据修改功能**: 明确不支持 INSERT、UPDATE、DELETE 等数据修改操作，仅限只读查询。

- **连接池管理**: 不提供高级连接池配置，使用默认的单连接策略。

- **查询性能分析**: 不提供 EXPLAIN 分析、查询优化建议或性能监控功能。

- **生产级安全特性**: 不提供凭据加密存储、审计日志、敏感数据遮蔽（查询结果中的信用卡号等）、安全删除（覆写）等生产级安全功能。本工具仅适用于开发环境。

- **系统表访问限制**: 不限制用户查询数据库系统表（如 `pg_catalog`、`information_schema`），这对调试有价值。
