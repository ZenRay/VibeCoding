# Security Requirements Quality Checklist

**Purpose**: 验证安全相关需求的完整性、清晰度和一致性  
**Created**: 2026-01-10  
**Feature**: 001-db-query-tool  
**Depth**: 标准 (~25 项)  
**Audience**: 规格编写者自查  
**Status**: ✅ 评审完成 - 通过率 52% (14/27) [修订后]  
**Reviewed**: 2026-01-10  
**Updated**: 2026-01-10 (根据评审结果更新 spec.md 和 data-model.md 后)

---

## 评审摘要

| 结果 | 数量 | 说明 |
|------|------|------|
| ✅ 通过 | 14 | 需求已明确定义 |
| 🟡 需改进 | 0 | 全部已修复 |
| 🔴 缺失 | 13 | 需求未定义（多数为开发工具可接受的权衡，已在 Out of Scope 说明） |

**注意**: 本项目定位为**开发环境工具**，许多 `[Gap]` 项在此场景下是**有意的设计决策**而非缺陷。已在 spec.md Out of Scope 章节明确说明。

---

## 凭据与敏感数据

- [x] **CHK001** - 凭据存储方式是否明确定义？规格是否说明凭据以明文存储及其适用场景？ [Completeness, Spec §FR-003]
  > ✅ **通过** - FR-003 明确说明"凭据以明文形式存储，适用于开发环境和受信任的本地使用场景"

- [x] **CHK002** - 安全警告的触发时机和内容是否完整定义？规格是否说明何时显示"凭据以明文存储"警告？ [Clarity, Spec §FR-003]
  > ✅ **通过** - FR-003 和 US1 场景 1 明确说明"首次添加连接时显示安全提示"

- [ ] **CHK003** - 是否定义了凭据在内存中的处理方式？（如：是否在使用后清除、是否避免日志记录） [Gap]
  > 🔴 **缺失** - 未定义内存中凭据处理。*开发工具场景可接受*

- [x] **CHK004** - 是否定义了凭据在 API 响应中的处理？`DatabaseConnectionResponse` 是否应排除密码字段？ [Gap, data-model.md]
  > ✅ **通过** [修订后] - data-model.md 已明确说明："`DatabaseConnectionResponse` 不包含密码字段（安全设计决策）"。FR-003 补充："API 响应（GET /api/v1/dbs）不返回密码字段"

- [x] **CHK005** - 连接 URL 中的密码在界面展示时是否需要遮蔽？是否有相关需求？ [Gap]
  > ✅ **通过** [修订后] - FR-003 已补充："界面展示连接信息时，密码字段必须遮蔽显示为 `***`，提供'显示密码'按钮临时显示"

---

## SQL 注入防护

- [x] **CHK006** - SQL 验证规则是否完整定义？是否列出所有禁止的语句类型？ [Completeness, Spec §FR-008]
  > ✅ **通过** - FR-008 列出禁止语句：INSERT、UPDATE、DELETE、DROP、ALTER、CREATE。data-model.md §5.2 补充了 TRUNCATE、GRANT、REVOKE、EXECUTE、CALL

- [ ] **CHK007** - 是否定义了如何防止 SQL 注入攻击？特别是用户输入的 SQL 是否需要参数化？ [Gap]
  > 🔴 **缺失** - 但架构设计为用户直接输入 SQL 并执行，参数化不适用。*系统通过仅允许 SELECT 来降低风险*

- [x] **CHK008** - 表名/列名特殊字符的转义规则是否明确？是否说明如何处理 SQL 关键字冲突？ [Clarity, Spec Edge Cases]
  > ✅ **通过** - Edge Cases 明确说明"应在元数据展示和查询生成时正确转义或使用引号包裹"

- [x] **CHK009** - AI 生成的 SQL 是否需要额外的安全验证？是否与手动输入 SQL 使用相同的验证规则？ [Consistency]
  > ✅ **通过** [修订后] - FR-012 已补充："AI 生成的 SQL 必须经过与手动输入相同的验证流程（语法检查、仅允许 SELECT）"。data-model.md §5.2 补充："所有 SQL 验证规则同时适用于手动输入的 SQL 和 AI 生成的 SQL"

- [x] **CHK010** - 是否定义了 SQL 最大长度限制的安全考量？ [Completeness, data-model.md §5.2]
  > ✅ **通过** - data-model.md §5.2 定义 `max_query_length: 10000` 字符

---

## 错误信息安全

- [ ] **CHK011** - 错误消息是否明确定义了不应暴露的敏感信息（如数据库内部结构、文件路径）？ [Gap]
  > 🔴 **缺失** - 未定义错误信息脱敏策略。*开发工具场景详细错误信息有助于调试*

- [x] **CHK012** - 连接失败的错误消息格式是否定义了信息披露边界？ [Clarity, Spec §FR-002]
  > ✅ **通过** - FR-002 定义了错误类型分类：网络不可达、认证失败、权限拒绝、数据库不存在

- [ ] **CHK013** - 数据库不存在 vs 认证失败的错误消息是否会导致信息泄露？是否需要统一为模糊消息？ [Gap]
  > 🔴 **缺失** - 但开发工具场景需要详细错误信息。*有意设计决策*

- [ ] **CHK014** - SQL 语法错误的错误信息是否可能暴露数据库结构？是否有相关限制？ [Gap, Spec §FR-014]
  > 🔴 **缺失** - FR-014 定义了错误格式但未限制信息披露。*开发工具场景可接受*

---

## 访问控制与边界

- [x] **CHK015** - "无认证访问"原则是否与安全环境假设一致？是否明确说明不适用于生产环境？ [Consistency, Spec §Dependencies]
  > ✅ **通过** - Dependencies & Assumptions 明确说明"假设系统运行在受信任的本地环境或开发环境中...不适用于生产环境或多用户共享环境"

- [ ] **CHK016** - 是否定义了对目标数据库的访问权限验证？系统是否应检查用户对特定表的读取权限？ [Gap]
  > 🔴 **缺失** - 系统依赖数据库自身的权限控制。FR-004 提到"如果部分表因权限不足无法提取"

- [ ] **CHK017** - 是否定义了防止访问系统表或敏感元数据的限制？ [Gap]
  > 🔴 **缺失** - 未限制系统表访问。*用户可能需要查看系统表进行调试*

- [x] **CHK018** - 是否定义了连接名称的安全验证规则？（如防止路径遍历 `../` 或特殊字符） [Gap, api.yaml]
  > ✅ **通过** [修订后] - FR-024 已补充连接名称验证规则：`^[a-zA-Z0-9_-]+$`，长度 1-100 字符。data-model.md §5.2 也补充了 `CONNECTION_NAME_RULES`

---

## 数据保护

- [ ] **CHK019** - 本地存储文件 (`meta.db`) 的权限设置是否有需求定义？ [Gap]
  > 🔴 **缺失** - 未定义文件权限。*依赖操作系统默认权限*

- [ ] **CHK020** - 查询结果中敏感数据的处理是否有定义？（如信用卡号、社保号的遮蔽） [Gap]
  > 🔴 **缺失** - 未定义敏感数据遮蔽。*开发工具需要看到真实数据*

- [ ] **CHK021** - 本地存储损坏恢复时，是否需要安全地销毁旧数据？ [Gap, Spec Edge Cases]
  > 🔴 **缺失** - Edge Cases 提到"自动重新创建空存储"但未说明旧数据处理

- [ ] **CHK022** - 元数据缓存清理时，是否需要安全删除（如覆写）而非简单删除？ [Gap]
  > 🔴 **缺失** - 未定义安全删除策略。*开发环境可接受简单删除*

---

## AI 服务安全

- [ ] **CHK023** - 发送给 AI 服务的元数据是否应有脱敏处理？（如排除敏感列名） [Gap]
  > 🔴 **缺失** - FR-013 说明"将数据库元数据作为上下文传递"但未提及脱敏

- [ ] **CHK024** - API Key 的存储和传输安全是否有需求定义？（环境变量是否足够安全） [Gap]
  > 🔴 **缺失** - 依赖环境变量存储，未定义其他安全措施

- [x] **CHK025** - AI 服务返回的 SQL 是否可能包含恶意内容？是否需要额外的安全扫描？ [Gap]
  > ✅ **通过** - 隐式通过：所有 SQL（包括 AI 生成的）都经过 FR-007/FR-008 的语法和语句类型验证

---

## 日志与审计

- [ ] **CHK026** - 是否定义了不应记录到日志的敏感信息？（如密码、查询结果） [Gap]
  > 🔴 **缺失** - 未定义日志脱敏策略

- [ ] **CHK027** - 是否需要记录安全相关事件的审计日志？（如连接失败、非法 SQL 尝试） [Gap]
  > 🔴 **缺失** - 未定义审计日志需求。*开发工具场景可省略*

---

## Summary

| 维度 | 项目数 | ✅ 通过 | 🟡 需改进 | 🔴 缺失 |
|------|--------|---------|-----------|---------|
| 凭据与敏感数据 | 5 | 4 | 0 | 1 |
| SQL 注入防护 | 5 | 4 | 0 | 1 |
| 错误信息安全 | 4 | 1 | 0 | 3 |
| 访问控制与边界 | 4 | 2 | 0 | 2 |
| 数据保护 | 4 | 0 | 0 | 4 |
| AI 服务安全 | 3 | 1 | 0 | 2 |
| 日志与审计 | 2 | 0 | 0 | 2 |
| **总计** | **27** | **14** | **0** | **13** |

---

## 评审结论

### 通过率: 52% (14/27) [修订后提升]

### 修订内容 (2026-01-10)

以下项目已通过更新 `spec.md` 和 `data-model.md` 解决：

| 项目 | 修订内容 |
|------|----------|
| CHK004 | data-model.md 明确说明 API 响应不返回密码字段 |
| CHK005 | FR-003 补充密码遮蔽显示需求 |
| CHK009 | FR-012 明确 AI 生成 SQL 使用相同验证规则 |
| CHK018 | FR-024 补充连接名称验证规则 |

### 重要发现

**✅ 优势领域**:
1. 凭据存储策略明确，包含安全警告
2. SQL 语句类型验证完整
3. 安全环境假设清晰定义
4. 密码遮蔽和 API 安全已定义
5. 连接名称验证防止注入攻击

**🔴 有意排除** (13 项):
已在 `Out of Scope` 章节明确说明以下安全特性不包含在开发工具中：
- 生产级安全特性（凭据加密、审计日志等）
- 系统表访问限制
- 敏感数据遮蔽（查询结果）

---

**评审者备注**: 安全需求已完善。所有 `[Gap]` 项已在 `Out of Scope` 中明确排除，符合开发工具定位。
