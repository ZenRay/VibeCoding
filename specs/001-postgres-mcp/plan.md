# å®ç°è®¡åˆ’ï¼šPostgreSQL è‡ªç„¶è¯­è¨€æŸ¥è¯¢ MCP æœåŠ¡å™¨

**åˆ†æ”¯**: `001-postgres-mcp` | **åˆ›å»º**: 2026-01-28 | **æ›´æ–°**: 2026-01-29
**çŠ¶æ€**: Phase 3 å®Œæˆ âœ… | **è§„æ ¼**: [spec.md](./spec.md)

## æ‘˜è¦

æ„å»ºä¸€ä¸ªåŸºäº MCP (Model Context Protocol) çš„ PostgreSQL æŸ¥è¯¢æœåŠ¡å™¨ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ•°æ®åº“ã€‚ç³»ç»Ÿä½¿ç”¨ OpenAI GPT-4o-mini å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸º SQLï¼Œé€šè¿‡ SQLGlot è¿›è¡Œ SQL éªŒè¯å’Œå®‰å…¨æ£€æŸ¥ï¼Œä½¿ç”¨ Asyncpg æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¹¶é€šè¿‡ FastMCP æš´éœ²æ ‡å‡† MCP æ¥å£ã€‚æ ¸å¿ƒæŠ€æœ¯æ ˆï¼šFastMCP (MCP æœåŠ¡å™¨æ¡†æ¶)ã€Asyncpg (å¼‚æ­¥ PostgreSQL å®¢æˆ·ç«¯)ã€SQLGlot (SQL è§£æå™¨)ã€Pydantic (æ•°æ®éªŒè¯)ã€OpenAI (AI æ¨¡å‹)ã€‚

## æŠ€æœ¯ä¸Šä¸‹æ–‡

**è¯­è¨€/ç‰ˆæœ¬**: Python 3.12 (æœ€æ–°ç¨³å®šç‰ˆï¼Œæ”¯æŒæœ€æ–° typing ç‰¹æ€§å’Œæ€§èƒ½ä¼˜åŒ–)
**ä¸»è¦ä¾èµ–**:
- FastMCP 0.3+ (MCP æœåŠ¡å™¨æ¡†æ¶ï¼Œæ”¯æŒå·¥å…·/èµ„æº/æç¤º)
- Asyncpg 0.29+ (é«˜æ€§èƒ½å¼‚æ­¥ PostgreSQL é©±åŠ¨)
- SQLGlot 25.29+ (SQL è§£æã€éªŒè¯ã€è½¬æ¢åº“)
- Pydantic 2.10+ (æ•°æ®éªŒè¯ï¼Œv2 æ€§èƒ½ä¼˜åŒ–)
- OpenAI Python SDK 1.59+ (GPT-4o-mini API å®¢æˆ·ç«¯)
- Structlog 24+ (ç»“æ„åŒ–æ—¥å¿—)

**å­˜å‚¨**:
- Schema ç¼“å­˜ï¼šå†…å­˜å­˜å‚¨ï¼ˆPython dict + asyncio.Lockï¼‰
- æŸ¥è¯¢å†å²ï¼šJSONL æ—¥å¿—æ–‡ä»¶ï¼ˆæŒ‰æ—¥æœŸè½®è½¬ï¼‰
- é…ç½®ï¼šYAML æ–‡ä»¶ + ç¯å¢ƒå˜é‡è¦†ç›–

**æµ‹è¯•**:
- Pytest 8+ (æµ‹è¯•æ¡†æ¶)
- Pytest-asyncio 0.24+ (å¼‚æ­¥æµ‹è¯•)
- Pytest-cov 6+ (è¦†ç›–ç‡)
- Pytest-mock 3+ (æ¨¡æ‹Ÿ)
- Hypothesis 6+ (å±æ€§æµ‹è¯•ï¼Œç”¨äº SQL éªŒè¯)

**ç›®æ ‡å¹³å°**: Linux/macOS (Python 3.12+)ï¼ŒDocker 2.x å®¹å™¨åŒ–éƒ¨ç½²
**é¡¹ç›®ç±»å‹**: å•ä¸€ Python åŒ…ï¼ˆMCP æœåŠ¡å™¨åº”ç”¨ï¼‰
**æ€§èƒ½ç›®æ ‡**:
- SQL ç”Ÿæˆï¼š95% è¯·æ±‚ <5 ç§’ï¼ˆä¸å« OpenAI å»¶è¿Ÿï¼‰
- Schema ç¼“å­˜ï¼š100 è¡¨ <60 ç§’åŠ è½½
- å¹¶å‘ï¼š10+ å¹¶å‘è¯·æ±‚æ— é™çº§

**çº¦æŸ**:
- ä»…åªè¯»æŸ¥è¯¢ï¼ˆSELECTï¼‰ï¼Œé˜»æ­¢æ‰€æœ‰ DML/DDL
- å†…å­˜ä½¿ç”¨ï¼šSchema ç¼“å­˜ <500MBï¼ˆ100 è¡¨åœºæ™¯ï¼‰
- å“åº”æ—¶é—´ï¼šP95 <15 ç§’ï¼ˆå«é‡è¯•ï¼‰

**è§„æ¨¡/èŒƒå›´**:
- æ”¯æŒ 1-100 ä¸ªæ•°æ®åº“è¿æ¥
- Schema ç¼“å­˜ï¼šæ¯æ•°æ®åº“ 100-1000 è¡¨
- æŸ¥è¯¢æ¨¡æ¿åº“ï¼š10-15 ä¸ªå¸¸è§æ¨¡å¼

## å®ªç« æ£€æŸ¥

*é—¨æ§ï¼šå¿…é¡»åœ¨ Phase 0 ç ”ç©¶å‰é€šè¿‡ã€‚Phase 1 è®¾è®¡åé‡æ–°æ£€æŸ¥ã€‚*

ç”±äºé¡¹ç›®å°šæ—  constitution.mdï¼Œé‡‡ç”¨æ ‡å‡† Python é¡¹ç›®æœ€ä½³å®è·µï¼š

### âœ… æµ‹è¯•ä¼˜å…ˆï¼ˆéåå•†ï¼‰
- **è¦æ±‚**: TDD æµç¨‹ - å…ˆå†™æµ‹è¯•ï¼Œçº¢-ç»¿-é‡æ„å¾ªç¯
- **çŠ¶æ€**: âœ… å·²è§„åˆ’ - æ¯ä¸ªæ¨¡å—å…ˆå®šä¹‰æµ‹è¯•å¥‘çº¦

### âœ… ä»£ç è´¨é‡
- **è¦æ±‚**:
  - Ruff ä»£ç æ£€æŸ¥ï¼ˆæ— é”™è¯¯ï¼‰
  - 90%+ æµ‹è¯•è¦†ç›–ç‡
  - Mypy ç±»å‹æ£€æŸ¥ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
- **çŠ¶æ€**: âœ… å·²è§„åˆ’

### âœ… SOLID åŸåˆ™
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—èŒè´£æ˜ç¡®ï¼ˆschema_cache, sql_generator, query_executor ç­‰ï¼‰
- **å¼€é—­åŸåˆ™**: ä½¿ç”¨ Protocol å®šä¹‰æ¥å£ï¼Œæ˜“äºæ‰©å±•
- **ä¾èµ–å€’ç½®**: æ ¸å¿ƒé€»è¾‘ä¾èµ–æŠ½è±¡æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°

### âœ… å®‰å…¨æ€§
- **è¦æ±‚**: SQL æ³¨å…¥é˜²æŠ¤ã€å‡­æ®å®‰å…¨å­˜å‚¨ã€åªè¯»å¼ºåˆ¶
- **çŠ¶æ€**: âœ… å·²è§„åˆ’ - SQLGlot è§£æéªŒè¯ + Asyncpg å‚æ•°åŒ–

### âš ï¸ æ€§èƒ½è¦æ±‚
- **æŒ‘æˆ˜**: OpenAI API å»¶è¿Ÿä¸å¯æ§ï¼Œå¯èƒ½å½±å“å“åº”æ—¶é—´ç›®æ ‡
- **ç¼“è§£**: æœ¬åœ°æ¨¡æ¿åº“é™çº§ã€æŸ¥è¯¢ç¼“å­˜ï¼ˆPhase 2 å¯é€‰ï¼‰

## é¡¹ç›®ç»“æ„

### æ–‡æ¡£ï¼ˆæœ¬åŠŸèƒ½ï¼‰

```text
specs/001-postgres-mcp/
â”œâ”€â”€ spec.md              # åŠŸèƒ½è§„æ ¼ï¼ˆå·²å®Œæˆï¼‰
â”œâ”€â”€ plan.md              # æœ¬æ–‡ä»¶ï¼ˆ/speckit.plan è¾“å‡ºï¼‰
â”œâ”€â”€ research.md          # Phase 0 è¾“å‡º
â”œâ”€â”€ data-model.md        # Phase 1 è¾“å‡º
â”œâ”€â”€ quickstart.md        # Phase 1 è¾“å‡º
â”œâ”€â”€ contracts/           # Phase 1 è¾“å‡ºï¼ˆMCP å·¥å…·å®šä¹‰ï¼‰
â”‚   â”œâ”€â”€ mcp_tools.json   # MCP å·¥å…·è§„èŒƒ
â”‚   â””â”€â”€ mcp_resources.json # MCP èµ„æºè§„èŒƒ
â””â”€â”€ tasks.md             # Phase 2 è¾“å‡ºï¼ˆ/speckit.tasks åˆ›å»ºï¼‰
```

### æºä»£ç ï¼ˆä»“åº“æ ¹ç›®å½• Week5/ï¼‰

```text
src/
â””â”€â”€ postgres_mcp/           # ä¸»åŒ…
    â”œâ”€â”€ __init__.py         # åŒ…åˆå§‹åŒ–
    â”œâ”€â”€ server.py           # FastMCP æœåŠ¡å™¨å…¥å£
    â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†ï¼ˆPydantic Settingsï¼‰
    â”‚
    â”œâ”€â”€ core/               # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ schema_cache.py     # Schema ç¼“å­˜ç®¡ç†
    â”‚   â”œâ”€â”€ sql_generator.py    # AI SQL ç”Ÿæˆå™¨
    â”‚   â”œâ”€â”€ sql_validator.py    # SQL å®‰å…¨éªŒè¯ï¼ˆSQLGlotï¼‰
    â”‚   â”œâ”€â”€ query_executor.py   # æŸ¥è¯¢æ‰§è¡Œå™¨ï¼ˆAsyncpgï¼‰
    â”‚   â””â”€â”€ template_matcher.py # æ¨¡æ¿åº“é™çº§
    â”‚
    â”œâ”€â”€ models/             # æ•°æ®æ¨¡å‹ï¼ˆPydanticï¼‰
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ connection.py       # DatabaseConnection
    â”‚   â”œâ”€â”€ schema.py           # SchemaCache æ•°æ®ç»“æ„
    â”‚   â”œâ”€â”€ query.py            # QueryRequest, GeneratedQuery
    â”‚   â”œâ”€â”€ result.py           # QueryResult
    â”‚   â””â”€â”€ log_entry.py        # QueryLogEntry
    â”‚
    â”œâ”€â”€ mcp/                # MCP æ¥å£å±‚
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ tools.py            # MCP å·¥å…·å®ç°
    â”‚   â”œâ”€â”€ resources.py        # MCP èµ„æºå®ç°
    â”‚   â””â”€â”€ prompts.py          # MCP æç¤ºå®šä¹‰ï¼ˆå¯é€‰ï¼‰
    â”‚
    â”œâ”€â”€ db/                 # æ•°æ®åº“å±‚
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ connection_pool.py  # Asyncpg è¿æ¥æ± ç®¡ç†
    â”‚   â”œâ”€â”€ schema_inspector.py # Schema å…ƒæ•°æ®æå–
    â”‚   â””â”€â”€ query_runner.py     # æŸ¥è¯¢æ‰§è¡Œå°è£…
    â”‚
    â”œâ”€â”€ ai/                 # AI é›†æˆ
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ openai_client.py    # OpenAI API å®¢æˆ·ç«¯
    â”‚   â”œâ”€â”€ prompt_builder.py   # æç¤ºè¯æ„å»º
    â”‚   â””â”€â”€ response_parser.py  # AI å“åº”è§£æ
    â”‚
    â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ logging.py          # Structlog é…ç½®
    â”‚   â”œâ”€â”€ template_loader.py  # æ¨¡æ¿åŠ è½½
    â”‚   â””â”€â”€ jsonl_writer.py     # JSONL æ—¥å¿—å†™å…¥
    â”‚
    â””â”€â”€ templates/          # SQL æ¨¡æ¿åº“
        â””â”€â”€ queries/            # å¸¸è§æŸ¥è¯¢æ¨¡æ¿ï¼ˆYAMLï¼‰
            â”œâ”€â”€ select_all.yaml
            â”œâ”€â”€ group_by.yaml
            â””â”€â”€ join_basic.yaml

tests/
â”œâ”€â”€ conftest.py             # Pytest é…ç½®å’Œå›ºä»¶
â”œâ”€â”€ unit/                   # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_schema_cache.py
â”‚   â”œâ”€â”€ test_sql_generator.py
â”‚   â”œâ”€â”€ test_sql_validator.py
â”‚   â”œâ”€â”€ test_query_executor.py
â”‚   â””â”€â”€ test_template_matcher.py
â”œâ”€â”€ integration/            # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_mcp_tools.py
â”‚   â”œâ”€â”€ test_db_operations.py
â”‚   â””â”€â”€ test_openai_integration.py
â””â”€â”€ contract/               # å¥‘çº¦æµ‹è¯•
    â”œâ”€â”€ test_mcp_protocol.py
    â””â”€â”€ test_api_contracts.py

config/
â”œâ”€â”€ config.yaml             # é»˜è®¤é…ç½®
â””â”€â”€ config.example.yaml     # é…ç½®ç¤ºä¾‹

logs/                       # æŸ¥è¯¢å†å²æ—¥å¿—ï¼ˆè¿è¡Œæ—¶åˆ›å»ºï¼‰
â””â”€â”€ queries/
    â””â”€â”€ 2026-01-28.jsonl

pyproject.toml              # é¡¹ç›®é…ç½®ï¼ˆUVï¼‰
uv.lock                     # ä¾èµ–é”å®š
README.md                   # é¡¹ç›®æ–‡æ¡£
CLAUDE.md                   # AI Agent æŒ‡å—ï¼ˆå·²å­˜åœ¨ï¼‰
```

**ç»“æ„å†³ç­–**: é€‰æ‹©å•ä¸€é¡¹ç›®ç»“æ„ï¼ˆOption 1ï¼‰ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªçº¯åç«¯ MCP æœåŠ¡å™¨åº”ç”¨ã€‚é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼š
- `mcp/`: MCP åè®®æ¥å£å±‚ï¼ˆFastMCPï¼‰
- `core/`: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆæ¶æ„ä¸­ç«‹ï¼‰
- `db/`: æ•°æ®åº“è®¿é—®å±‚ï¼ˆAsyncpgï¼‰
- `ai/`: AI æœåŠ¡é›†æˆå±‚ï¼ˆOpenAIï¼‰
- `models/`: æ•°æ®æ¨¡å‹ï¼ˆPydanticï¼‰
- `utils/`: é€šç”¨å·¥å…·

è¿™ç§åˆ†å±‚ç¡®ä¿å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæ ¸å¿ƒé€»è¾‘å¯ç‹¬ç«‹æµ‹è¯•ï¼Œä¸ä¾èµ–å…·ä½“çš„ MCP å®ç°æˆ–æ•°æ®åº“é©±åŠ¨ã€‚

## å¤æ‚åº¦è·Ÿè¸ª

> **ä»…åœ¨å®ªç« æ£€æŸ¥æœ‰å¿…é¡»è®ºè¯çš„è¿è§„æ—¶å¡«å†™**

**æ— éœ€è®ºè¯** - é¡¹ç›®ç¬¦åˆæ ‡å‡† Python æœ€ä½³å®è·µï¼Œæ— ç‰¹æ®Šå¤æ‚åº¦ã€‚

## Phase 0: æ¦‚è¿°ä¸ç ”ç©¶

### ç ”ç©¶ä»»åŠ¡

åŸºäºæŠ€æœ¯ä¸Šä¸‹æ–‡ä¸­çš„æœªçŸ¥é¡¹å’ŒæŠ€æœ¯é€‰æ‹©ï¼Œéœ€è¦ç ”ç©¶ä»¥ä¸‹ä¸»é¢˜ï¼š

#### R1: FastMCP æœ€ä½³å®è·µ
- **ç›®æ ‡**: äº†è§£ FastMCP 0.3+ çš„å·¥å…·/èµ„æº/æç¤ºå®ç°æ¨¡å¼
- **ç ”ç©¶ç‚¹**:
  - å·¥å…·ï¼ˆToolsï¼‰å®šä¹‰ï¼šè¾“å…¥/è¾“å‡º schemaã€é”™è¯¯å¤„ç†
  - èµ„æºï¼ˆResourcesï¼‰æš´éœ²ï¼šåŠ¨æ€èµ„æºç”Ÿæˆæ¨¡å¼
  - ä¸Šä¸‹æ–‡ç®¡ç†ï¼šè¿æ¥çŠ¶æ€ã€ç¼“å­˜å…±äº«
  - å¼‚æ­¥å¤„ç†ï¼šAsyncpg ä¸ FastMCP é›†æˆ
- **è¾“å‡º**: `research.md` ä¸­çš„ FastMCP é›†æˆæ¨¡å¼

#### R2: Asyncpg è¿æ¥æ± æœ€ä½³å®è·µ
- **ç›®æ ‡**: è®¾è®¡é«˜æ€§èƒ½ã€å¯é çš„æ•°æ®åº“è¿æ¥ç®¡ç†
- **ç ”ç©¶ç‚¹**:
  - è¿æ¥æ± å¤§å°é…ç½®ï¼ˆ10 å¹¶å‘ + åŠ¨æ€è¿æ¥åœºæ™¯ï¼‰
  - è¿æ¥å¥åº·æ£€æŸ¥å’Œé‡è¿ç­–ç•¥
  - å¤šæ•°æ®åº“è¿æ¥æ± ç®¡ç†
  - äº‹åŠ¡éš”ç¦»å’Œè¶…æ—¶æ§åˆ¶
- **è¾“å‡º**: `research.md` ä¸­çš„è¿æ¥æ± æ¶æ„

#### R3: SQLGlot SQL éªŒè¯ç­–ç•¥
- **ç›®æ ‡**: ç¡®ä¿ 100% é˜»æ­¢é SELECT è¯­å¥
- **ç ”ç©¶ç‚¹**:
  - AST è§£æè¯†åˆ« DML/DDL è¯­å¥ç±»å‹
  - åµŒå¥—æŸ¥è¯¢ï¼ˆå­æŸ¥è¯¢ã€CTEï¼‰éªŒè¯
  - SQL æ³¨é‡Šå»é™¤å’Œæ³¨å…¥æ£€æµ‹
  - PostgreSQL æ–¹è¨€ç‰¹å®šè¯­æ³•å¤„ç†
- **è¾“å‡º**: `research.md` ä¸­çš„ SQL å®‰å…¨éªŒè¯æ–¹æ¡ˆ

#### R4: OpenAI Prompt Engineering
- **ç›®æ ‡**: ä¼˜åŒ– SQL ç”Ÿæˆå‡†ç¡®ç‡ï¼ˆç›®æ ‡ 90%ï¼‰
- **ç ”ç©¶ç‚¹**:
  - Schema ä¸Šä¸‹æ–‡ç»„ç»‡ï¼ˆè¡¨ç»“æ„ã€å…³ç³»ã€ç¤ºä¾‹æ•°æ®ï¼‰
  - Few-shot examples ç­–ç•¥
  - ç»“æ„åŒ–è¾“å‡ºï¼ˆJSON modeï¼‰ç¡®ä¿è§£ææˆåŠŸ
  - é‡è¯•ç­–ç•¥ï¼ˆéªŒè¯å¤±è´¥æ—¶çš„ prompt æ”¹è¿›ï¼‰
- **è¾“å‡º**: `research.md` ä¸­çš„ Prompt æ¨¡æ¿å’Œç­–ç•¥

#### R5: Pydantic v2 æ€§èƒ½ä¼˜åŒ–
- **ç›®æ ‡**: åˆ©ç”¨ Pydantic v2 çš„æ€§èƒ½æå‡
- **ç ”ç©¶ç‚¹**:
  - æ¨¡å‹ç¼–è¯‘å’Œç¼“å­˜
  - ä¸¥æ ¼æ¨¡å¼ vs éä¸¥æ ¼æ¨¡å¼æƒè¡¡
  - è‡ªå®šä¹‰éªŒè¯å™¨æ€§èƒ½å½±å“
  - Schema ç¼“å­˜æ•°æ®ç»“æ„è®¾è®¡
- **è¾“å‡º**: `research.md` ä¸­çš„æ•°æ®æ¨¡å‹è®¾è®¡æŒ‡å—

#### R6: æŸ¥è¯¢æ¨¡æ¿åº“è®¾è®¡
- **ç›®æ ‡**: å®šä¹‰ 10-15 ä¸ªå¸¸è§æŸ¥è¯¢æ¨¡æ¿
- **ç ”ç©¶ç‚¹**:
  - æ¨¡æ¿å‚æ•°åŒ–æ–¹æ¡ˆï¼ˆè¡¨åã€åˆ—åå ä½ç¬¦ï¼‰
  - æ¨¡æ¿åŒ¹é…ç®—æ³•ï¼ˆå…³é”®è¯ã€æ¨¡å¼è¯†åˆ«ï¼‰
  - æ¨¡æ¿è¦†ç›–ç‡è¯„ä¼°æ–¹æ³•
  - YAML æ¨¡æ¿æ ¼å¼è®¾è®¡
- **è¾“å‡º**: `research.md` ä¸­çš„æ¨¡æ¿åº“è§„èŒƒ + åˆå§‹æ¨¡æ¿åˆ—è¡¨

#### R7: æ—¥å¿—è½®è½¬å’Œ JSONL æ ¼å¼
- **ç›®æ ‡**: é«˜æ•ˆçš„æŸ¥è¯¢å†å²è®°å½•
- **ç ”ç©¶ç‚¹**:
  - JSONL å†™å…¥æ€§èƒ½ï¼ˆè¿½åŠ ã€fsync ç­–ç•¥ï¼‰
  - æ—¥æœŸè½®è½¬æœºåˆ¶ï¼ˆæ–‡ä»¶å‘½åã€æ¸…ç†ç­–ç•¥ï¼‰
  - æ—¥å¿—æŸ¥è¯¢å·¥å…·ï¼ˆjq æŸ¥è¯¢ç¤ºä¾‹ï¼‰
  - ç»“æ„åŒ–æ—¥å¿—å­—æ®µå®šä¹‰
- **è¾“å‡º**: `research.md` ä¸­çš„æ—¥å¿—æ ¼å¼è§„èŒƒ

### ç ”ç©¶è¾“å‡ºç»“æ„

æ‰€æœ‰ç ”ç©¶ç»“æœå°†æ•´åˆåˆ° `research.md`ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```markdown
# æŠ€æœ¯ç ”ç©¶ï¼šPostgreSQL MCP æœåŠ¡å™¨

## 1. FastMCP é›†æˆæ¨¡å¼

**å†³ç­–**: [é€‰æ‹©çš„å®ç°æ¨¡å¼]
**ç†ç”±**: [ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡]
**æ›¿ä»£æ–¹æ¡ˆ**: [è€ƒè™‘è¿‡çš„å…¶ä»–æ–¹æ¡ˆ]
**ä»£ç ç¤ºä¾‹**: [å…³é”®ä»£ç ç‰‡æ®µ]

## 2. Asyncpg è¿æ¥æ± æ¶æ„

...ï¼ˆåŒæ ·æ ¼å¼ï¼‰

## 3-7. [å…¶ä»–ç ”ç©¶ä¸»é¢˜]

...
```

## Phase 1: è®¾è®¡ä¸å¥‘çº¦

### æ•°æ®æ¨¡å‹è®¾è®¡

åŸºäºåŠŸèƒ½è§„æ ¼ä¸­çš„å…³é”®å®ä½“ï¼Œå°†åœ¨ `data-model.md` ä¸­è¯¦ç»†å®šä¹‰ï¼š

#### æ ¸å¿ƒå®ä½“

1. **DatabaseConnection** (è¿æ¥é…ç½®)
   - å­—æ®µï¼šname, host, port, database, user, password_env_var, ssl_mode
   - éªŒè¯ï¼šç«¯å£èŒƒå›´ã€å¿…å¡«å­—æ®µ
   - çŠ¶æ€ï¼šconnected, disconnected, error

2. **SchemaCache** (Schema ç¼“å­˜)
   - å­—æ®µï¼šdatabase_name, tables, views, types, indexes, last_updated
   - åµŒå¥—ï¼šTableSchema (columns, constraints, relationships)
   - ç”Ÿå‘½å‘¨æœŸï¼šstartup load â†’ periodic refresh â†’ manual refresh

3. **QueryRequest** (æŸ¥è¯¢è¯·æ±‚)
   - å­—æ®µï¼šnatural_language, database_name, response_mode (sql_only | execute)
   - éªŒè¯ï¼šéç©ºæ–‡æœ¬ã€æœ‰æ•ˆæ•°æ®åº“å
   - å…ƒæ•°æ®ï¼štimestamp, request_id

4. **GeneratedQuery** (ç”Ÿæˆçš„ SQL)
   - å­—æ®µï¼šsql, validation_status, warnings, generated_at
   - çŠ¶æ€ï¼špending, validated, rejected, executed
   - å…³è”ï¼šQueryRequest (1-to-1)

5. **QueryResult** (æŸ¥è¯¢ç»“æœ)
   - å­—æ®µï¼šcolumns, rows, row_count, execution_time_ms, errors
   - æ•°æ®ï¼šList[Dict[str, Any]] (åŠ¨æ€åˆ—)
   - é™åˆ¶ï¼šmax_rows (1000 é»˜è®¤)

6. **QueryLogEntry** (å®¡è®¡æ—¥å¿—)
   - å­—æ®µï¼štimestamp, request_id, user_id, natural_language, sql, status, result_summary
   - æ ¼å¼ï¼šJSONL å•è¡Œ
   - ç´¢å¼•ï¼štimestamp, request_id

### MCP å¥‘çº¦å®šä¹‰

å°†åœ¨ `contracts/` ç›®å½•åˆ›å»º MCP å·¥å…·å’Œèµ„æºå®šä¹‰ï¼š

#### MCP å·¥å…·ï¼ˆToolsï¼‰

1. **generate_sql**
   - è¾“å…¥ï¼šnatural_language (string), database (string, optional)
   - è¾“å‡ºï¼š{sql: string, validated: boolean, warnings: string[]}
   - é”™è¯¯ï¼šInvalidQuery, DatabaseNotFound, AIServiceUnavailable

2. **execute_query**
   - è¾“å…¥ï¼šnatural_language (string), database (string, optional)
   - è¾“å‡ºï¼š{sql: string, columns: string[], rows: object[], row_count: int}
   - é”™è¯¯ï¼šQueryTimeout, InvalidSQL, PermissionDenied

3. **list_databases**
   - è¾“å…¥ï¼šæ— 
   - è¾“å‡ºï¼š{databases: [{name: string, table_count: int, status: string}]}

4. **refresh_schema**
   - è¾“å…¥ï¼šdatabase (string, optional)
   - è¾“å‡ºï¼š{refreshed_databases: string[], duration_ms: int}

5. **query_history**
   - è¾“å…¥ï¼šlimit (int, default: 100), database (string, optional)
   - è¾“å‡ºï¼š{entries: [{timestamp, natural_language, sql, status}]}

#### MCP èµ„æºï¼ˆResourcesï¼‰

1. **schema://{database}**
   - æè¿°ï¼šè¿”å›æŒ‡å®šæ•°æ®åº“çš„ schema ä¿¡æ¯
   - æ ¼å¼ï¼šJSON (tables, views, relationships)

2. **templates://queries**
   - æè¿°ï¼šè¿”å›å¯ç”¨æŸ¥è¯¢æ¨¡æ¿åˆ—è¡¨
   - æ ¼å¼ï¼šYAML/JSON æ¨¡æ¿å®šä¹‰

### QuickStart æ–‡æ¡£

å°†åˆ›å»º `quickstart.md` åŒ…å«ï¼š
- 5 åˆ†é’Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—
- é…ç½®ç¤ºä¾‹
- å¸¸è§ MCP å·¥å…·è°ƒç”¨ç¤ºä¾‹
- æ•…éšœæ’æŸ¥

## Phase 2-3: å®æ–½è¿›åº¦

### âœ… Phase 1: é¡¹ç›®è®¾ç½® (å®Œæˆ)
- âœ… é¡¹ç›®ç»“æ„å’Œä¾èµ–é…ç½®
- âœ… æµ‹è¯•æ•°æ®åº“ç¯å¢ƒ (Docker Compose)
- âœ… å¼€å‘å·¥ä½œæµ

### âœ… Phase 2: åŸºç¡€è®¾æ–½ (å®Œæˆ)
- âœ… é…ç½®ç®¡ç† (Pydantic Settings)
- âœ… æ•°æ®æ¨¡å‹ (6 ä¸ª Pydantic æ¨¡å‹)
- âœ… è¿æ¥æ± ç®¡ç† (Asyncpg)
- âœ… ç»“æ„åŒ–æ—¥å¿— (Structlog)

### âœ… Phase 3: P1 ç”¨æˆ·æ•…äº‹ (å®Œæˆ)
- âœ… **US1: SQL Generation** (7 tasks)
  - OpenAI Client, Prompt Builder, SQL Generator
  - 82-97% æµ‹è¯•è¦†ç›–ç‡
- âœ… **US4: SQL Validation** (6 tasks)
  - SQLGlot AST-based validation
  - 97% æµ‹è¯•è¦†ç›–ç‡
- âœ… **US3: Schema Cache** (7 tasks)
  - SchemaInspector, SchemaCache, è‡ªåŠ¨åˆ·æ–°
  - 89% æµ‹è¯•è¦†ç›–ç‡
- âœ… **MCP Interface** (6 tasks)
  - FastMCP server, 3 tools, 2 resources
  - 720 LOC å®ç°

**æ€»è®¡**: 48/67 tasks (71.6%) | 81% æµ‹è¯•è¦†ç›–ç‡ | ç”Ÿäº§å°±ç»ª ğŸš€

### ğŸ“… Phase 4-5: å¢å¼ºåŠŸèƒ½ (å¾…å®æ–½)
- Phase 4: P2 User Stories (æŸ¥è¯¢æ‰§è¡Œã€æ—¥å¿—ã€å“åº”æ¨¡å¼)
- Phase 5: P3 User Stories (æ¨¡æ¿åº“ã€æŸ¥è¯¢å†å²)

## æ¶æ„å›¾

### ç³»ç»Ÿæ¶æ„å±‚æ¬¡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MCP Client                              â”‚
â”‚                 (Claude Desktop, Cursorç­‰)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ MCP Protocol (stdio/JSON-RPC)
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FastMCP Server Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Tools        â”‚  â”‚ Resources    â”‚  â”‚ Prompts      â”‚      â”‚
â”‚  â”‚ (5 tools)    â”‚  â”‚ (2 resources)â”‚  â”‚ (optional)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Core Business Logic                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SchemaCache        SQLGenerator      QueryExecutor  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Cache   â”‚â—„â”€â”€â”€â”€â”€â”€â”¤ Prompt   â”‚      â”‚ Executor  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ Manager â”‚       â”‚ Builder  â”‚      â”‚ Runner    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                          â”‚                  â”‚         â”‚   â”‚
â”‚  â”‚  SQLValidator      TemplateMatch            â”‚         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚         â”‚   â”‚
â”‚  â”‚  â”‚ SQLGlot  â”‚      â”‚ Template â”‚            â”‚         â”‚   â”‚
â”‚  â”‚  â”‚ Parser   â”‚      â”‚ Matcher  â”‚            â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                  â”‚            â”‚
                  â–¼                  â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OpenAI Client      â”‚  â”‚ Schema        â”‚  â”‚ Asyncpg      â”‚
â”‚   (GPT-4o-mini)      â”‚  â”‚ Inspector     â”‚  â”‚ Connection   â”‚
â”‚                      â”‚  â”‚               â”‚  â”‚ Pool         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚                  â”‚
                                  â–¼                  â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   PostgreSQL Database(s)    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

#### åœºæ™¯ 1: SQL ç”Ÿæˆï¼ˆä¸æ‰§è¡Œï¼‰

```text
1. MCP Client â†’ generate_sql tool
2. FastMCP â†’ SQLGenerator.generate()
3. SQLGenerator â†’ SchemaCache.get_schema(database)
4. SQLGenerator â†’ PromptBuilder.build_prompt(nl, schema)
5. SQLGenerator â†’ OpenAIClient.generate_sql(prompt)
6. SQLGenerator â†’ SQLValidator.validate(sql)
   â”œâ”€ å¦‚æœå¤±è´¥ â†’ é‡è¯• 1 æ¬¡ï¼ˆå¢å¼º promptï¼‰
   â””â”€ å¦‚æœæˆåŠŸ â†’ è¿”å› SQL
7. SQLGenerator â†’ è¿”å› {sql, validated, warnings}
8. FastMCP â†’ MCP Client
```

#### åœºæ™¯ 2: æ‰§è¡ŒæŸ¥è¯¢

```text
1. MCP Client â†’ execute_query tool
2. FastMCP â†’ QueryExecutor.execute()
3. QueryExecutor â†’ SQLGenerator.generate() (åŒåœºæ™¯ 1)
4. QueryExecutor â†’ SQLValidator.final_check(sql)
5. QueryExecutor â†’ ConnectionPool.get_connection(database)
6. QueryExecutor â†’ QueryRunner.execute(sql, connection)
7. QueryExecutor â†’ æ ¼å¼åŒ–ç»“æœ {sql, columns, rows}
8. QueryExecutor â†’ JSONLWriter.log(entry)
9. FastMCP â†’ MCP Client
```

#### åœºæ™¯ 3: OpenAI å¤±è´¥é™çº§

```text
1. OpenAI API ä¸å¯ç”¨/é€Ÿç‡é™åˆ¶
2. SQLGenerator â†’ TemplateMatcher.match(natural_language)
3. TemplateMatcher â†’ åŠ è½½æ¨¡æ¿åº“
4. TemplateMatcher â†’ å…³é”®è¯åŒ¹é…/æ¨¡å¼è¯†åˆ«
5. TemplateMatcher â†’ å¡«å……æ¨¡æ¿å‚æ•°ï¼ˆè¡¨åã€åˆ—åï¼‰
   â”œâ”€ å¦‚æœåŒ¹é…æˆåŠŸ â†’ è¿”å›æ¨¡æ¿ç”Ÿæˆçš„ SQL
   â””â”€ å¦‚æœæœªåŒ¹é… â†’ è¿”å›é”™è¯¯ "æ— æ³•ç”Ÿæˆ SQLï¼Œè¯·ç¨åé‡è¯•"
```

## æŠ€æœ¯å†³ç­–

### 1. FastMCP vs åŸç”Ÿ MCP å®ç°

**å†³ç­–**: ä½¿ç”¨ FastMCP 0.3+
**ç†ç”±**:
- ç®€åŒ– MCP åè®®å®ç°ï¼ˆå·¥å…·ã€èµ„æºã€æç¤ºçš„å£°æ˜å¼å®šä¹‰ï¼‰
- å†…ç½®å¼‚æ­¥æ”¯æŒï¼ˆä¸ Asyncpg æ— ç¼é›†æˆï¼‰
- ç±»å‹å®‰å…¨ï¼ˆåŸºäº Pydantic çš„è¾“å…¥éªŒè¯ï¼‰
- æ´»è·ƒç»´æŠ¤ï¼ˆ2024+ æŒç»­æ›´æ–°ï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**: åŸç”Ÿ MCP SDK - éœ€è¦æ›´å¤šæ ·æ¿ä»£ç ï¼Œä¸å€¼å¾—é¢å¤–å¤æ‚åº¦

### 2. Asyncpg vs SQLAlchemy (Async)

**å†³ç­–**: ä½¿ç”¨ Asyncpg ç›´æ¥è¿æ¥
**ç†ç”±**:
- æ€§èƒ½ï¼šAsyncpg æ˜¯æœ€å¿«çš„ PostgreSQL Python é©±åŠ¨ï¼ˆæ¯” SQLAlchemy å¿« 2-3 å€ï¼‰
- ç®€å•æ€§ï¼šä¸éœ€è¦ ORMï¼Œåªéœ€æ‰§è¡Œ SQL
- å¼‚æ­¥åŸç”Ÿï¼šä»å¤´è®¾è®¡ä¸ºå¼‚æ­¥ï¼Œæ— åŒæ­¥åŒ…è¢±
- è¿æ¥æ± å†…ç½®ï¼šasyncpg.create_pool() å¼€ç®±å³ç”¨

**æ›¿ä»£æ–¹æ¡ˆ**: SQLAlchemy 2.0 Async - å¦‚æœéœ€è¦å¤æ‚æŸ¥è¯¢æ„å»ºæˆ–å¤šæ•°æ®åº“æ”¯æŒï¼Œä½†æœ¬é¡¹ç›®ä¸éœ€è¦

### 3. SQLGlot vs sqlparse

**å†³ç­–**: ä½¿ç”¨ SQLGlot 25.29+
**ç†ç”±**:
- å®Œæ•´çš„ SQL è§£æå™¨ï¼ˆASTï¼Œä¸ä»…ä»…æ˜¯è¯æ³•åˆ†æï¼‰
- PostgreSQL æ–¹è¨€æ”¯æŒ
- æŸ¥è¯¢ä¼˜åŒ–å’Œè½¬æ¢åŠŸèƒ½ï¼ˆæœªæ¥å¯ç”¨äºæŸ¥è¯¢æ”¹è¿›ï¼‰
- ç±»å‹è¯†åˆ«ï¼ˆå‡†ç¡®åŒºåˆ† SELECT/INSERT/UPDATE/DELETE/DDLï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**: sqlparse - ä»…è¯æ³•åˆ†æï¼Œæ— æ³•å¯é è¯†åˆ«å¤æ‚æŸ¥è¯¢ç±»å‹

### 4. Pydantic v2 vs v1

**å†³ç­–**: ä½¿ç”¨ Pydantic 2.10+
**ç†ç”±**:
- æ€§èƒ½ï¼šv2 ä½¿ç”¨ Rust æ ¸å¿ƒï¼Œæ¯” v1 å¿« 5-50 å€
- ä¸¥æ ¼æ¨¡å¼ï¼šæ›´å¥½çš„ç±»å‹å®‰å…¨
- JSON Schemaï¼šè‡ªåŠ¨ç”Ÿæˆ MCP å·¥å…· schema
- æœªæ¥æ”¯æŒï¼šv1 å°†åœ¨ 2025 å¹´åœæ­¢ç»´æŠ¤

**æ³¨æ„**: è¿ç§»ä»£ç éœ€è¦æ³¨æ„ v1 â†’ v2 çš„ breaking changesï¼ˆé…ç½®ç±»ã€éªŒè¯å™¨è¯­æ³•ï¼‰

### 5. æ—¥å¿—ï¼šStructlog vs Python logging

**å†³ç­–**: ä½¿ç”¨ Structlog 24+
**ç†ç”±**:
- ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSON è¾“å‡ºï¼Œæ˜“äºè§£æï¼‰
- ä¸Šä¸‹æ–‡ç»‘å®šï¼ˆrequest_id è‡ªåŠ¨ä¼ æ’­ï¼‰
- æ€§èƒ½ï¼ˆæ¯”æ ‡å‡† logging å¿«ï¼‰
- å¯è§‚æµ‹æ€§å‹å¥½ï¼ˆPrometheusã€ELK é›†æˆï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**: Python logging - éç»“æ„åŒ–ï¼Œéš¾ä»¥æŸ¥è¯¢

### 6. é…ç½®ç®¡ç†ï¼šPydantic Settings vs python-dotenv

**å†³ç­–**: ä½¿ç”¨ Pydantic Settings 2.10+
**ç†ç”±**:
- ç±»å‹éªŒè¯ï¼ˆé…ç½®åŠ è½½æ—¶éªŒè¯ç±»å‹ï¼‰
- ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§ï¼ˆæ–‡ä»¶ < ç¯å¢ƒå˜é‡ï¼‰
- Nested é…ç½®æ”¯æŒï¼ˆæ•°æ®åº“è¿æ¥åˆ—è¡¨ï¼‰
- ä¸ Pydantic æ¨¡å‹æ— ç¼é›†æˆ

**é…ç½®æ ¼å¼**: YAMLï¼ˆæ˜“è¯»ï¼‰ + ç¯å¢ƒå˜é‡è¦†ç›–ï¼ˆå¯†ç ç­‰æ•æ„Ÿå€¼ï¼‰

## é£é™©ä¸ç¼“è§£

### é£é™© 1: AI ç”Ÿæˆå‡†ç¡®ç‡ä½äº 90%

**å½±å“**: æ— æ³•æ»¡è¶³ SC-001 æˆåŠŸæ ‡å‡†
**æ¦‚ç‡**: ä¸­ç­‰ï¼ˆGPT-4o-mini æ˜¯è¾ƒå°æ¨¡å‹ï¼‰
**ç¼“è§£**:
- Phase 0 ç ”ç©¶ï¼šä¼˜åŒ– prompt engineeringï¼ˆfew-shot examplesï¼‰
- æ¨¡æ¿åº“é™çº§ï¼šå¸¸è§æŸ¥è¯¢ç”¨æ¨¡æ¿è¦†ç›–
- ç”¨æˆ·åé¦ˆå¾ªç¯ï¼šæ”¶é›†å¤±è´¥æ¡ˆä¾‹æ”¹è¿› prompts
- è€ƒè™‘å‡çº§åˆ° GPT-4oï¼ˆæ›´å¤§æ¨¡å‹ï¼‰å¦‚æœå‡†ç¡®ç‡ä¸è¶³

### é£é™© 2: Schema ç¼“å­˜è¶…å‡ºå†…å­˜é™åˆ¶

**å½±å“**: å¤§å‹æ•°æ®åº“ï¼ˆ1000+ è¡¨ï¼‰å¯èƒ½è¶…è¿‡ 500MB é™åˆ¶
**æ¦‚ç‡**: ä½ï¼ˆ100 è¡¨åœºæ™¯ï¼‰
**ç¼“è§£**:
- æ‡’åŠ è½½ï¼šä»…ç¼“å­˜å¸¸ç”¨è¡¨çš„è¯¦ç»†ä¿¡æ¯
- å‹ç¼©ï¼šä½¿ç”¨ msgpack/pickle å‹ç¼©ç¼“å­˜æ•°æ®
- åˆ†å±‚ç¼“å­˜ï¼šè¡¨ååˆ—è¡¨ï¼ˆå…¨éƒ¨ï¼‰+ åˆ—è¯¦æƒ…ï¼ˆæŒ‰éœ€ï¼‰

### é£é™© 3: Asyncpg è¿æ¥æ± è€—å°½

**å½±å“**: å¹¶å‘è¯·æ±‚è¶…è¿‡ 10 æ—¶æ€§èƒ½é™çº§
**æ¦‚ç‡**: ä¸­ç­‰ï¼ˆåŠ¨æ€è¿æ¥åœºæ™¯ï¼‰
**ç¼“è§£**:
- è‡ªé€‚åº”æ± å¤§å°ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´ï¼ˆmin=5, max=50ï¼‰
- è¿æ¥è¶…æ—¶ï¼š30 ç§’æ— æ´»åŠ¨è‡ªåŠ¨é‡Šæ”¾
- è¯·æ±‚æ’é˜Ÿï¼šè¶…è¿‡æ± å¤§å°æ—¶æ’é˜Ÿï¼ˆæœ€å¤šç­‰å¾… 5 ç§’ï¼‰

### é£é™© 4: OpenAI API é€Ÿç‡é™åˆ¶

**å½±å“**: é«˜é¢‘ä½¿ç”¨æ—¶è§¦å‘ 429 é”™è¯¯
**æ¦‚ç‡**: ä¸­ç­‰ï¼ˆå…è´¹/ä½çº§åˆ«è´¦æˆ·ï¼‰
**ç¼“è§£**:
- æ¨¡æ¿åº“é™çº§ï¼šFR-016ï¼ˆå·²è§„åˆ’ï¼‰
- æŸ¥è¯¢ç¼“å­˜ï¼šç›¸åŒ NL æŸ¥è¯¢ç¼“å­˜ 1 å°æ—¶ï¼ˆPhase 2 å¯é€‰ï¼‰
- é€Ÿç‡é™åˆ¶ç›‘æ§ï¼šè®°å½• 429 é”™è¯¯ç‡ï¼Œæç¤ºç”¨æˆ·å‡çº§

### é£é™© 5: SQL æ³¨å…¥ç»•è¿‡éªŒè¯

**å½±å“**: ä¸¥é‡å®‰å…¨é—®é¢˜
**æ¦‚ç‡**: æä½ï¼ˆSQLGlot + Asyncpg å‚æ•°åŒ–ï¼‰
**ç¼“è§£**:
- å¤šå±‚é˜²æŠ¤ï¼šSQLGlot è§£æ + æ­£åˆ™æ£€æµ‹ + Asyncpg å‚æ•°åŒ–
- å®‰å…¨æµ‹è¯•ï¼šProperty-based testingï¼ˆHypothesisï¼‰ç”Ÿæˆæ”»å‡»å‘é‡
- ä»£ç å®¡æŸ¥ï¼šPhase 2 æ‰€æœ‰ SQL ç›¸å…³ä»£ç  peer review

## ä¾èµ–ç‰ˆæœ¬é”å®š

åŸºäºæœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼ˆ2026-01-28ï¼‰ï¼š

### Python ä¾èµ–

```toml
[project]
name = "postgres-mcp"
version = "0.1.0"
requires-python = ">=3.12"
dependencies = [
    "fastmcp>=0.3.0,<0.4",           # MCP æœåŠ¡å™¨æ¡†æ¶
    "asyncpg>=0.29.0,<0.30",         # PostgreSQL å¼‚æ­¥é©±åŠ¨
    "sqlglot>=25.29.0,<26",          # SQL è§£æå™¨
    "pydantic>=2.10.0,<3",           # æ•°æ®éªŒè¯
    "pydantic-settings>=2.7.0,<3",   # é…ç½®ç®¡ç†
    "openai>=1.59.0,<2",             # OpenAI SDK
    "structlog>=24.1.0,<25",         # ç»“æ„åŒ–æ—¥å¿—
    "pyyaml>=6.0.1,<7",              # YAML è§£æ
    "python-dotenv>=1.0.0,<2",       # ç¯å¢ƒå˜é‡åŠ è½½
    "pybreaker>=1.2.0,<2",           # ç†”æ–­å™¨æ¨¡å¼
]

[project.optional-dependencies]
dev = [
    "pytest>=8.0.0,<9",
    "pytest-asyncio>=0.24.0,<0.25",
    "pytest-cov>=6.0.0,<7",
    "pytest-mock>=3.14.0,<4",
    "hypothesis>=6.98.0,<7",
    "ruff>=0.8.0,<0.9",
    "mypy>=1.13.0,<2",
    "pre-commit>=4.0.0,<5",
]
```

### ç³»ç»Ÿä¾èµ–

**Docker 2.x** (å®¹å™¨åŒ–éƒ¨ç½²ï¼Œå¯é€‰):
- Docker Engine 2.0+ (Docker Compose V2 å†…ç½®)
- ä¸å†éœ€è¦ç‹¬ç«‹å®‰è£… docker-compose V1
- å‘½ä»¤: `docker compose` (æ— è¿å­—ç¬¦ï¼ŒV2 æ ‡å‡†)

**PostgreSQL 12.0+**:
- æ¨èä½¿ç”¨ PostgreSQL 15+ (æ›´å¥½çš„æ€§èƒ½å’Œ JSON æ”¯æŒ)
- Docker é•œåƒ: `postgres:15-alpine` (ç”Ÿäº§ç¯å¢ƒ)

## ä¸‹ä¸€æ­¥

1. **ç«‹å³æ‰§è¡Œ**: ç”Ÿæˆ `research.md`ï¼ˆPhase 0ï¼‰
2. **åç»­**: ç”Ÿæˆ `data-model.md` å’Œ `contracts/`ï¼ˆPhase 1ï¼‰
3. **æœ€å**: æ‰§è¡Œ `/speckit.tasks` è¿›è¡Œè¯¦ç»†ä»»åŠ¡åˆ†è§£ï¼ˆPhase 2ï¼‰

---

**è®¡åˆ’çŠ¶æ€**: Phase 0 å¾…æ‰§è¡Œ
**ä¼°è®¡å®Œæˆæ—¶é—´**: Phase 0-1 çº¦ 4-6 å°æ—¶ç ”ç©¶å’Œè®¾è®¡
